<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Golang on Unladen swallow</title>
    <link>https://blog.owulveryck.info/tags/golang.xml</link>
    <description>Recent content in Golang on Unladen swallow</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>All rights reserved - 2015/2017</copyright>
    <atom:link href="https://blog.owulveryck.info/tags/golang.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Linda&#39;s evalc, a (tuple)space oddity</title>
      <link>https://blog.owulveryck.info/2017/03/13/lindas-evalc-a-tuplespace-oddity/index.html</link>
      <pubDate>Mon, 13 Mar 2017 20:54:27 +0100</pubDate>
      
      <guid>https://blog.owulveryck.info/2017/03/13/lindas-evalc-a-tuplespace-oddity/index.html</guid>
      <description>

&lt;p&gt;For a change, I will start with a good soundtrack&lt;/p&gt;

&lt;iframe src=&#34;https://embed.spotify.com/?uri=spotify:track:72Z17vmmeQKAg8bptWvpVG&amp;theme=white&#34; width=&#34;220&#34; height=&#34;80&#34; frameborder=&#34;0&#34; allowtransparency=&#34;true&#34;&gt;&lt;/iframe&gt;

&lt;p&gt;(&lt;a href=&#34;https://www.youtube.com/watch?v=iYYRH4apXDo&#34;&gt;youtube version&lt;/a&gt; for those who are spotify-less)&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;This is my third article about the distributed coordination language Linda.&lt;/p&gt;

&lt;p&gt;The final target of the work is to use this coordination mechanism to deploy and maintain applications based on the description of their topology (using, for example, TOSCA as a DSL).&lt;/p&gt;

&lt;p&gt;Last time, I introduced a lisp based language (zygomys) as an embedded programing mechanism to describe the business logic.&lt;/p&gt;

&lt;p&gt;Today I will explain how I have implemented a new &lt;em&gt;action&lt;/em&gt; in the linda language to achieve a new step: to distribute the work among different nodes.&lt;/p&gt;

&lt;p&gt;My test scenario remains the &amp;ldquo;dining of the philosophers&amp;rdquo;.&lt;/p&gt;

&lt;h1 id=&#34;introducing-evalc&#34;&gt;Introducing &lt;em&gt;evalc&lt;/em&gt;&lt;/h1&gt;

&lt;p&gt;Linda is a coordination language, but the language which is more than 30 years old, has not been designed with the idea of running on multiple hosts.
The basic primitives of the language do not allow remote execution.&lt;/p&gt;

&lt;p&gt;What I need is a sort of &lt;em&gt;eval&lt;/em&gt; function that would trigger the execution of the evaluation on another host instead of another goroutine.&lt;/p&gt;

&lt;p&gt;I do not care about catching the result of the execution as it will be posted to the tuple space.
Indeed, if more coordination between the actors of this RPC is needed, it can be encoded using the in/out mechanism of linda.&lt;/p&gt;

&lt;p&gt;Therefore, I have decided to introduce a new primitive called &lt;em&gt;evalc&lt;/em&gt; (for eval compute&amp;hellip; Yeah I know, I have imagination)&lt;/p&gt;

&lt;h1 id=&#34;implementing-evalc&#34;&gt;Implementing &lt;em&gt;evalc&lt;/em&gt;&lt;/h1&gt;

&lt;p&gt;The evalc will not trigger a function on a new host.
Instead, each participating host will run a sort of agent (actually a clone of the zygo interpreter) that will watch a certain type of event (tainted with the evalc) and will then execute a function.&lt;/p&gt;

&lt;p&gt;The tuple space acts like a communication channel and this implementation is like a kind of &lt;a href=&#34;https://en.wikipedia.org/wiki/Communicating_sequential_processes&#34;&gt;CSP&lt;/a&gt; which I like a lot.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;evalc&lt;/em&gt; will work exactly as its equivalent &lt;em&gt;eval&lt;/em&gt;. Therefore the function declaration in go will look like this:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;func&lt;/span&gt; (l &lt;span style=&#34;color: #666666&#34;&gt;*&lt;/span&gt;Linda) EvalC(env &lt;span style=&#34;color: #666666&#34;&gt;*&lt;/span&gt;zygo.Glisp, name &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;, args []zygo.Sexp) (zygo.Sexp, &lt;span style=&#34;color: #B00040&#34;&gt;error&lt;/span&gt;) {
    &lt;span style=&#34;color: #666666&#34;&gt;...&lt;/span&gt;
    &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;return&lt;/span&gt; zygo.SexpNull, &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;nil&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id=&#34;first-attempt&#34;&gt;First attempt&lt;/h2&gt;

&lt;p&gt;At first I thought I could simply gob/encode the &lt;code&gt;args&lt;/code&gt; which contains the &lt;code&gt;SexpFunction&lt;/code&gt;, post it in the tuple space under a prefixed key. Then the worker would read an execute it in a newly created &lt;code&gt;glisp&lt;/code&gt; env.&lt;/p&gt;

&lt;p&gt;That didn&amp;rsquo;t work mainly because the &lt;code&gt;SexpFunction&lt;/code&gt; does not have any exported fields, therefore I cannot easily encode/decode it.&lt;/p&gt;

&lt;p&gt;I though then that I could encode the &lt;code&gt;datastack&lt;/code&gt; and post it in the tuple space. I could then decode it in the worker.&lt;/p&gt;

&lt;p&gt;I asked for some advice to the author of zygomys &lt;a href=&#34;https://www.linkedin.com/in/jason-e-aten-ph-d-45a31318&#34;&gt;Jason E. Aten&lt;/a&gt; (aka &lt;a href=&#34;https://github.com/glycerine&#34;&gt;glycerine&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Here is what he told me (thank you Jason btw):&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Evaluating an arbitrary expression remotely will be challenging because an expression can refer to any variable in the environment, and so would theoretically require a copying of the whole environment&amp;ndash;the heap as well as the datastack.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;And of course he is right!
So I will keep the idea of encoding the whole environment and send it to the workers for a later implementation.
It would need to change the zygomys implementation a lot so export and import both stack. That is too much for now.&lt;/p&gt;

&lt;h2 id=&#34;second-attempt&#34;&gt;Second attempt&lt;/h2&gt;

&lt;p&gt;What I did as a temporary solution is a lot simpler and not elegant at all: I have posted the function and the variables in the tuple space and then I am evaluating it in a newly created env.&lt;/p&gt;

&lt;p&gt;The main problem is that I cannot access to variables and user function defined outside of the scope of the function. But that will do the trick for now.&lt;/p&gt;

&lt;p&gt;Regarding the problem of the philosopher, I had to change the definition of &lt;code&gt;phil&lt;/code&gt; within my lisp code so it do not call &lt;code&gt;(eat)&lt;/code&gt; and &lt;code&gt;(think)&lt;/code&gt; functions anymore.&lt;/p&gt;

&lt;p&gt;Here is what is posted in the tuple space when the evalc function is called:
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;(&lt;span style=&#34;color: #19177C&#34;&gt;defn&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;phil&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;[i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;num]&lt;/span&gt; ((&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt; (&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt; (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is thinking\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #008000&#34;&gt;sleep&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;10000&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;/%v is thinking\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;room ticket&amp;quot;&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is in the room\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v took the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v took the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt; (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is eating\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #008000&#34;&gt;sleep&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;10000&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;/%v is eating\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v released the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v released the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;)) (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v left the room\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;room ticket&amp;quot;&lt;/span&gt;) (&lt;span style=&#34;color: #19177C&#34;&gt;phil&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;)))) &lt;span style=&#34;color: #666666&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;In the worker process, I am creating a new environment, loading the function (the &lt;code&gt;defn&lt;/code&gt; part), and constructing an expression to be evaluated by the env.
This is what the environment evalutates:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;(&lt;span style=&#34;color: #19177C&#34;&gt;defn&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;phil&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;[i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;num]&lt;/span&gt; (
   (&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt;
    (&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt;
     (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is thinking\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
     (&lt;span style=&#34;color: #008000&#34;&gt;sleep&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;10000&lt;/span&gt;)
     (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;/%v is thinking\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;room ticket&amp;quot;&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is in the room\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v took the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v took the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;begin&lt;/span&gt;
     (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v is eating\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
     (&lt;span style=&#34;color: #008000&#34;&gt;sleep&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;10000&lt;/span&gt;)
     (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;/%v is eating\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v released the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v released the %v&amp;#39;s chopstick\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;chopstick&amp;quot;&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;mod&lt;/span&gt; (&lt;span style=&#34;color: #008000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;))
    (&lt;span style=&#34;color: #19177C&#34;&gt;printf&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;%v left the room\n&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;out&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;room ticket&amp;quot;&lt;/span&gt;)
    (&lt;span style=&#34;color: #19177C&#34;&gt;phil&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;num&lt;/span&gt;))))
(&lt;span style=&#34;color: #19177C&#34;&gt;phil&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;5&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id=&#34;runtime&#34;&gt;Runtime&lt;/h1&gt;

&lt;h2 id=&#34;running-it-locally-one-etcd-and-several-workers&#34;&gt;Running it locally: one etcd and several workers&lt;/h2&gt;

&lt;p&gt;To run it locally I need:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;a local instance of &lt;code&gt;etcd&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;5 workers.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Each worker will watch for a new event in the tuple space.
Then I can trigger the execution of the logic with a sixth worker that will read the lisp code, and execute it.&lt;/p&gt;

&lt;p&gt;Here is a screenshot of the execution
&lt;img src=&#34;https://raw.githubusercontent.com/ditrit/go-linda/master/doc/v0.3.png&#34; alt=&#34;Runtime screenshot&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;Jason E. Aten also told me about &lt;em&gt;sigils&lt;/em&gt; as a way to discriminate the local variables from the variables present in the tuple space.
I haven&amp;rsquo;t worked on it yet, but I think that I will use those &lt;em&gt;sigils&lt;/em&gt; to enhance my linda implementation. It can be usefull for the matching of templates and formals.&lt;/p&gt;

&lt;p&gt;By now, I have something that is able to run a basic theorical coordination problem.&lt;/p&gt;

&lt;p&gt;Now I think that I will go back to the application management task and see how I can encode the TOSCA workflow so it can be used by this mechanism.&lt;/p&gt;

&lt;p&gt;Meanwhile, I will try to test this setup on a worldwide cluster (maybe based on CoreOS).&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Credit:&lt;/p&gt;

&lt;p&gt;The illustration has been found &lt;a href=&#34;https://www.flickr.com/photos/joebehr/23704122254&#34;&gt;here&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>350000 rows, 133 cols... From a huge CSV to DynamoDB (without breaking piggy-bank).</title>
      <link>https://blog.owulveryck.info/2017/03/11/350000-rows-133-cols...-from-a-huge-csv-to-dynamodb-without-breaking-piggy-bank./index.html</link>
      <pubDate>Sat, 11 Mar 2017 09:15:17 +0100</pubDate>
      
      <guid>https://blog.owulveryck.info/2017/03/11/350000-rows-133-cols...-from-a-huge-csv-to-dynamodb-without-breaking-piggy-bank./index.html</guid>
      <description>

&lt;p&gt;In this post I will explain how to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Parse a CSV file and extract only certain columns&lt;/li&gt;
&lt;li&gt;Create a table in DynamoDB&lt;/li&gt;
&lt;li&gt;Insert all the data with an adaptive algorithm in order to use the provisioned capacity&lt;/li&gt;
&lt;li&gt;Reduce the capacity once the insertion is done.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;exploring-the-problem-aws-billing&#34;&gt;Exploring the problem: AWS Billing&lt;/h1&gt;

&lt;p&gt;In a &lt;a href=&#34;https://blog.owulveryck.info/2017/01/13/a-foot-in-nosql-and-a-toe-in-big-data/&#34;&gt;previous post&lt;/a&gt; I explained how I was using dynamodb to store a lot of data about aws billing.&lt;/p&gt;

&lt;p&gt;On top of the API that deals with products and offers, AWS can provide a &amp;ldquo;billing report&amp;rdquo;. Those reports are delivered to am Amazon S3 bucket in CSV format at least once a day.&lt;/p&gt;

&lt;p&gt;The rows of the CSV are organized in &lt;em&gt;topics&lt;/em&gt; as described &lt;a href=&#34;http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/billing-reports.html#Topics&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Each line of the CSV represents an item that is billed. But every resource is made of several billable items. For example on EC2, you pay the &amp;ldquo;compute&amp;rdquo;, the bandwidth, the volume etc&amp;hellip;&lt;/p&gt;

&lt;p&gt;I would like to use and understand this file to optimize the costs. A kind of BI.&lt;/p&gt;

&lt;p&gt;AWS says that you can import your file in Excel (or alike)&amp;hellip; That could be a solution but:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://imgs.xkcd.com/comics/algorithms.png&#34; alt=&#34;Excel XKCD&#34; /&gt;&lt;/p&gt;

&lt;p&gt;On top of that with a lot of resources the file is fat (more thant a 100000 lines several times a day for my client).
I have decided to use dynamodb to store all the information so it will be easy to perform an extract and generate a dashboard.
In this post, I will expose some go techniques I have used to achive that.&lt;/p&gt;

&lt;h1 id=&#34;step-1-parsing-the-csv&#34;&gt;Step 1: Parsing the CSV&lt;/h1&gt;

&lt;p&gt;As I explained, the CSV file is made of more than a hundreds cols. The columns are identified in the first row of the CSV.
I will store each row in a go struct.&lt;/p&gt;

&lt;p&gt;To parse it easily, I an using custom fields &lt;code&gt;csv&lt;/code&gt; in the struct. The field value corresponds to the header name for the seek value.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;type&lt;/span&gt; test &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; {
    ID   &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;myid&amp;quot;`&lt;/span&gt;
    Name &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;prenom&amp;quot;`&lt;/span&gt;
    Last &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;nom&amp;quot;`&lt;/span&gt;
    Test &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;nonexitent&amp;quot;`&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then, I am reading the first row of the CSV file and then ranging the field names of the struct to fill a map with the field key as key and the col number as value. I set &amp;lsquo;-1&amp;rsquo; if the field is not found:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;var&lt;/span&gt; headers = &lt;span style=&#34;color: #008000&#34;&gt;make&lt;/span&gt;(&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;map&lt;/span&gt;[&lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;]&lt;span style=&#34;color: #B00040&#34;&gt;int&lt;/span&gt;, et.NumField())
&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;0&lt;/span&gt;; i &amp;lt; et.NumField(); i&lt;span style=&#34;color: #666666&#34;&gt;++&lt;/span&gt; {
        headers[et.Field(i).Name] = &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;func&lt;/span&gt;(element &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;, array []&lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;) &lt;span style=&#34;color: #B00040&#34;&gt;int&lt;/span&gt; {
                &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; k, v &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;range&lt;/span&gt; array {
                        &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;if&lt;/span&gt; v &lt;span style=&#34;color: #666666&#34;&gt;==&lt;/span&gt; element {
                                &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;return&lt;/span&gt; k
                        }
                }
                &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;-1&lt;/span&gt;
        }(et.Field(i).Tag.Get(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;csv&amp;quot;&lt;/span&gt;), header)
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then I can parse the CSV file and fill a channel with one object by row&amp;hellip;
See the full example &lt;a href=&#34;https://gist.github.com/owulveryck/0fc68c90fa4875647b54f62e2066707d&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;step-2-creating-the-table-in-dynamodb&#34;&gt;Step 2: Creating the table in DynamoDB&lt;/h1&gt;

&lt;p&gt;This step is &amp;ldquo;easy&amp;rdquo;. I will create a table with one index and a sort key.
For the example the index is a string named &lt;code&gt;Key&lt;/code&gt;. The sort key is also a string named &lt;code&gt;SortKey&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;AttributeDefinitions: []&lt;span style=&#34;color: #666666&#34;&gt;*&lt;/span&gt;dynamodb.AttributeDefinition{
        {
                AttributeName: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;Key&amp;quot;&lt;/span&gt;),
                AttributeType: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;S&amp;quot;&lt;/span&gt;),
        },
        {
                AttributeName: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;SortKey&amp;quot;&lt;/span&gt;),
                AttributeType: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;S&amp;quot;&lt;/span&gt;),
        },
},
KeySchema: []&lt;span style=&#34;color: #666666&#34;&gt;*&lt;/span&gt;dynamodb.KeySchemaElement{
        {
                AttributeName: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;Key&amp;quot;&lt;/span&gt;),
                KeyType:       aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;HASH&amp;quot;&lt;/span&gt;),
        },
        {
                AttributeName: aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;SortKey&amp;quot;&lt;/span&gt;),
                KeyType:       aws.String(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;RANGE&amp;quot;&lt;/span&gt;),
        },
},
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;I will set an initial provisioning of 600. This would cost a lot of money but I will reduce it later to spare. The high provisioning rate is needed otherwise it would take me hours to integrate the CSV.&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;ProvisionedThroughput: &lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;dynamodb.ProvisionedThroughput{
        ReadCapacityUnits:  aws.Int64(&lt;span style=&#34;color: #666666&#34;&gt;5&lt;/span&gt;),
        WriteCapacityUnits: aws.Int64(&lt;span style=&#34;color: #666666&#34;&gt;300&lt;/span&gt;),
},
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code for creating the table is &lt;a href=&#34;https://gist.github.com/owulveryck/6663983b41c669617704558a030a3392#file-dynamodbcreatetable-go&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;step-3-inserting-the-data&#34;&gt;Step 3: Inserting the data&lt;/h1&gt;

&lt;p&gt;The structure is read through the channel I have created previously.
The object is encoded to a dynamodb compatible one thanks the &lt;code&gt;marshal&lt;/code&gt; function of this helper library &lt;code&gt;github.com/aws/aws-sdk-go/service/dynamodb/dynamodbattribute&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;To make the structure ID match the &lt;code&gt;Key&lt;/code&gt; attribute of the table, I am using the &lt;code&gt;dynamodbav&lt;/code&gt; fields.
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;type&lt;/span&gt; test &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; {
    ID   &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;myid&amp;quot; dynamodbav:&amp;quot;Key&amp;quot;`&lt;/span&gt;
    Name &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;prenom&amp;quot; dynamodbav:&amp;quot;SortKey&amp;quot;`&lt;/span&gt;
    Last &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;nom&amp;quot; dynamodbav:&amp;quot;Last,omitempty&amp;quot;`&lt;/span&gt;
    Test &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`csv:&amp;quot;nonexitent&amp;quot;`&lt;/span&gt;
}
&lt;span style=&#34;color: #666666&#34;&gt;...&lt;/span&gt;
&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; v &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;range&lt;/span&gt; c {
    item, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; dynamodbattribute.MarshalMap(v)
    params &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;dynamodb.PutItemInput{
        Item:      item,
        TableName: aws.String(tableName),
    }
    svc.PutItem(params)
}
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;h2 id=&#34;going-concurrent&#34;&gt;Going concurrent&lt;/h2&gt;

&lt;p&gt;I will add a touch of concurrency. I will use a maximum of 20 goroutines simultaneously to send items to the dynamodb.
This is an empiric decision.&lt;/p&gt;

&lt;p&gt;I am using a &amp;ldquo;guard&amp;rdquo; channel. This channel has a buffer of 20. The buffed is filled with am empty struct whenever an item is received in the main communication channel.
I am then launching a gorouting that will insert the event into dynamodb and consume one event from the guard channel when done.&lt;/p&gt;

&lt;p&gt;The guard channel is blocking when it is full. Therefore I am sure that 20 goroutines will run at maximum:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;guard &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000&#34;&gt;make&lt;/span&gt;(&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;chan&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt;{}, &lt;span style=&#34;color: #666666&#34;&gt;20&lt;/span&gt;)
&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; v &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;range&lt;/span&gt; c {
    guard &lt;span style=&#34;color: #666666&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt;{}{}
    &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;go&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;func&lt;/span&gt;(v &lt;span style=&#34;color: #666666&#34;&gt;*&lt;/span&gt;test) {
        item, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; dynamodbattribute.MarshalMap(v)
        params &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;dynamodb.PutItemInput{
            Item:      item,
            TableName: aws.String(tableName),
        }
        svc.PutItem(params)
        &lt;span style=&#34;color: #666666&#34;&gt;&amp;lt;-&lt;/span&gt;guard
    }
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id=&#34;using-a-backoff-algorithm&#34;&gt;Using a backoff algorithm&lt;/h2&gt;

&lt;p&gt;The problem with this implementation is that it can overload the capacity.
Therefore the rejected event must be resent. Of course I can simply check for the error &lt;code&gt;dynamodb.ErrCodeProvisionedThroughputExceededException&lt;/code&gt; an immediately resend the failed event.&lt;/p&gt;

&lt;p&gt;But this may lead to dramatic performances.
The AWS documentation point an Exponential Backoff algorithm as an advice to optimize the writing: &lt;a href=&#34;http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Programming.Errors.html#Programming.Errors.RetryAndBackoff&#34;&gt;Cf AWS documentation)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Wikipedia gives a good &lt;a href=&#34;https://en.wikipedia.org/wiki/Exponential_backoff&#34;&gt;explanation of the exponential backoff&lt;/a&gt; but to make it simple the idea is to decrease the ration of insertion of the DB in order to get a good performance.&lt;/p&gt;

&lt;p&gt;I am using a go implenenation found on &lt;a href=&#34;http://github.com/cenkalti/backoff&#34;&gt;github&lt;/a&gt; made by &lt;a href=&#34;https://github.com/cenkalti&#34;&gt;Cenkalti&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I return the error only in case of &lt;code&gt;dynamodb.ErrCodeProvisionedThroughputExceededException&lt;/code&gt; by now:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;backoff.Retry(&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;func&lt;/span&gt;() &lt;span style=&#34;color: #B00040&#34;&gt;error&lt;/span&gt; {
    &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Now put the item, discarding the result&lt;/span&gt;
    _ , err = svcDB.PutItem(params)
    &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;if&lt;/span&gt; err &lt;span style=&#34;color: #666666&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;nil&lt;/span&gt; {
        &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;if&lt;/span&gt; err.(awserr.Error).Code() &lt;span style=&#34;color: #666666&#34;&gt;==&lt;/span&gt; dynamodb.ErrCodeProvisionedThroughputExceededException {
            &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;return&lt;/span&gt; err
        }
        &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// TODO: Special case...&lt;/span&gt;
        log.Printf(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;Error inserting %v (%v)&amp;quot;&lt;/span&gt;, v, err)
    }
    &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Do the insert here&lt;/span&gt;
    &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;nil&lt;/span&gt;
}, backoff.NewExponentialBackOff())
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id=&#34;step-4-updating-the-table-and-reducing-the-write-capacity&#34;&gt;Step 4: Updating the table and reducing the write capacity&lt;/h1&gt;

&lt;p&gt;Once the insert is done, to avoid a huge bill, I am reducing the Provisioned capacity of the table.
This is done with an &lt;code&gt;update&lt;/code&gt; request:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;params &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;dynamodb.UpdateTableInput{
    TableName: aws.String(tableName), &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Required&lt;/span&gt;
    ProvisionedThroughput: &lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;dynamodb.ProvisionedThroughput{
        ReadCapacityUnits:  aws.Int64(&lt;span style=&#34;color: #666666&#34;&gt;10&lt;/span&gt;), &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Required&lt;/span&gt;
        WriteCapacityUnits: aws.Int64(&lt;span style=&#34;color: #666666&#34;&gt;1&lt;/span&gt;),  &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Required&lt;/span&gt;
    },
}
resp, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; svc.UpdateTable(params)
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id=&#34;conclusion-it-works&#34;&gt;Conclusion: it works&lt;/h1&gt;

&lt;p&gt;It took me half an hour to process and insert 350000 lines (with 133 rows each) into the dynamodb from my laptop.&lt;/p&gt;

&lt;p&gt;I can see that the adaptative algorithm works on the graphs:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://blog.owulveryck.info/assets/images/dynamodb/dynamodb_write_capacity.png&#34; alt=&#34;It works&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Now I can analyse the data to find a proper way to optimize the aws bill for my client.&lt;/p&gt;

&lt;p&gt;The full example is on &lt;a href=&#34;https://gist.github.com/owulveryck/6663983b41c669617704558a030a3392&#34;&gt;gist&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>A foot in NoSQL and a toe in big data</title>
      <link>https://blog.owulveryck.info/2017/01/13/a-foot-in-nosql-and-a-toe-in-big-data/index.html</link>
      <pubDate>Fri, 13 Jan 2017 22:22:46 +0100</pubDate>
      
      <guid>https://blog.owulveryck.info/2017/01/13/a-foot-in-nosql-and-a-toe-in-big-data/index.html</guid>
      <description>

&lt;p&gt;The more I work with AWS, the more I understand their models. This goes far beyond the technical principles of micro service.
As an example I recently had an opportunity to dig a bit into the billing process.
I had an explanation given by a colleague whose understanding was more advanced than mine.
In his explanation, he mentioned this blog post: &lt;a href=&#34;https://aws.amazon.com/blogs/aws/new-aws-price-list-api/&#34;&gt;New price list API&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&#34;understanding-the-model&#34;&gt;Understanding the model&lt;/h1&gt;

&lt;p&gt;By reading this post and this &lt;a href=&#34;http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/price-changes.html&#34;&gt;explanation&lt;/a&gt;, I understand that the offers are categorized in families (eg AmazonS3) and that an offer is composed of a set of products.
Each product is characterized by its SKU&amp;rsquo;s reference (&lt;a href=&#34;https://en.wikipedia.org/wiki/Stock_keeping_unit&#34;&gt;stock-keeping unit&lt;/a&gt;)&lt;/p&gt;

&lt;h2 id=&#34;inventory-management&#34;&gt;Inventory management&lt;/h2&gt;

&lt;p&gt;So finally, it is just about inventory management. In the retail, when you say &amp;ldquo;inventory management&amp;rdquo;, the IT usually replies with millions dollars &lt;em&gt;ERP&lt;/em&gt;.
And the more items we have, the more processing power we need and then more dollar are involved&amp;hellip; and richer the IT specialists are (just kidding).&lt;/p&gt;

&lt;p&gt;Moreover enhancing an item by adding some attributes can be painful and risky&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://imgs.xkcd.com/comics/exploits_of_a_mom.png&#34; alt=&#34;xkcd&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;the-nosql-approach&#34;&gt;The NoSQL approach&lt;/h2&gt;

&lt;p&gt;Due to the rise of the online shopping, inventory management must be real time.
The stock inventory is a business service. and placing it in a micro service architecture bring constraints: the request should be satisfied in micro seconds.&lt;/p&gt;

&lt;p&gt;More over, the key/value concept allows to store &amp;ldquo;anything&amp;rdquo; in a value. Therefore, you can store a list of attributes regardless of what the attributes are.&lt;/p&gt;

&lt;p&gt;When it comes to NoSQL, there are usually two approaches to store the data:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;simple Key/Value;&lt;/li&gt;
&lt;li&gt;document-oriented.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;At first I did and experiment with a simple key/value store called BoltDB (which is more or less like Redis).
In this approach the value stored was a json representation&amp;hellip; A kind of document.
Then I though that it could be a good idea to use a more document oriented service: DynamoDB&lt;/p&gt;

&lt;h1 id=&#34;geek-time&#34;&gt;Geek time&lt;/h1&gt;

&lt;p&gt;In this part I will explain how to get the data from AWS and to store them in the dynamoDB service. The code is written in GO and is just a proof of concept.&lt;/p&gt;

&lt;h2 id=&#34;the-product-informations&#34;&gt;The product informations&lt;/h2&gt;

&lt;p&gt;A product&amp;rsquo;s technical representation is described &lt;a href=&#34;http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/reading-an-offer.html&#34;&gt;here&lt;/a&gt;.
We have:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;Product Details&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt; {
   &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;sku&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt; {
      &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;sku&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;The SKU of the product&amp;quot;&lt;/span&gt;,
      &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;productFamily&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;The product family of the product&amp;quot;&lt;/span&gt;,
      &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;attributes&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt; {
         &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;attributeName&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #666666&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;attributeValue&amp;quot;&lt;/span&gt;,
      }
   }
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;There are three important entries but only two are mandatories:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;SKU&lt;/em&gt;: A unique code for a product.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Product Family&lt;/em&gt;: The category for the type of product. For example, compute for Amazon EC2 or storage for Amazon S3.&lt;/li&gt;
&lt;li&gt;Attributes: A list of all of the product attributes.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;creating-the-table&#34;&gt;Creating the &amp;ldquo;table&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;As my goal is for now to create a proof of concept and play with the data, I am creating the table manually.
DynamoDB allows the creation of two indexes per table. So I create a table &lt;em&gt;Products&lt;/em&gt; with two indexes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;SKU&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ProductFamily&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://blog.owulveryck.info/assets/images/bigdata/blog-dynamo-create-table.png&#34; alt=&#34;Create Table&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;principle&#34;&gt;Principle&lt;/h2&gt;

&lt;p&gt;The data is retrieved by a simple &lt;code&gt;http.Get&lt;/code&gt; method. Then a &lt;code&gt;json.Decoder&lt;/code&gt; takes the body (an &lt;code&gt;io.Reader&lt;/code&gt;) as argument and decode it in a predefined structure.
Once the structure is filled, I will store it in the DynamoDB.&lt;/p&gt;

&lt;h3 id=&#34;the-structures&#34;&gt;The structures&lt;/h3&gt;

&lt;p&gt;I need three go structures. Two will be used to decode and range through the offer index. The other one will hold all the product details for a specific offer.&lt;/p&gt;

&lt;h4 id=&#34;offer-index&#34;&gt;Offer Index&lt;/h4&gt;

&lt;p&gt;The offer index is composed of offers referenced in by an offer name (&lt;code&gt;map[string]offer&lt;/code&gt;)
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;type&lt;/span&gt; offerIndex &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; {
    FormatVersion   &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;           &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;formatVersion&amp;quot;`&lt;/span&gt;
    Disclaimer      &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;           &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;disclaimer&amp;quot;`&lt;/span&gt;
    PublicationDate time.Time        &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;publicationDate&amp;quot;`&lt;/span&gt;
    Offers          &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;map&lt;/span&gt;[&lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;]offer &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;offers&amp;quot;`&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;An offer in the index is characterized by three elements. I am catching all of them, but only &lt;code&gt;CurrrentVersionURL&lt;/code&gt; is useful in my case.
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;type&lt;/span&gt; offer &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; {
    OfferCode         &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;offerCode:&amp;quot;`&lt;/span&gt;
    VersionIndexURL   &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;versionIndexUrl&amp;quot;`&lt;/span&gt;
    CurrentVersionURL &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;currentVersionUrl&amp;quot;`&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;h4 id=&#34;products&#34;&gt;Products&lt;/h4&gt;

&lt;p&gt;I hold all the product details in a structure. The product details holds all the products in a map whose key is the SKU. Therefore a SKU field is useless.
The Attribute value is an interface{} because it can be of any type (more on this later in the post).&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note&lt;/em&gt; : In case of massive data flow, it would probably be better to decode the stream pieces by pieces (as written in the &lt;a href=&#34;https://golang.org/pkg/encoding/json/#Decoder.Decode&#34;&gt;the go documentation&lt;/a&gt;)&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;type&lt;/span&gt; productDetails &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; {
    Products &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;map&lt;/span&gt;[&lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;]&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;struct&lt;/span&gt; { &lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// the key is SKU&lt;/span&gt;
        ProductFamily &lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;                 &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;productFamily&amp;quot;`&lt;/span&gt;
        Attributes    &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;map&lt;/span&gt;[&lt;span style=&#34;color: #B00040&#34;&gt;string&lt;/span&gt;]&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;interface&lt;/span&gt;{} &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;attributes&amp;quot;`&lt;/span&gt;
    } &lt;span style=&#34;color: #BA2121&#34;&gt;`json:&amp;quot;products&amp;quot;`&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id=&#34;getting-the-data&#34;&gt;Getting the data&lt;/h3&gt;

&lt;h4 id=&#34;offers&#34;&gt;Offers&lt;/h4&gt;

&lt;p&gt;The first action is to grab the json of the offer index and put it in a object of type &lt;code&gt;offerIndex&lt;/code&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;resp, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; http.Get(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;https://pricing.us-east-1.amazonaws.com/offers/v1.0/aws/index.json&amp;quot;&lt;/span&gt;)

&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;var&lt;/span&gt; oi offerIndex
err = json.NewDecoder(resp.Body).Decode(&lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;oi)
&lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// oi contains all the offers&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;Then loop for each offer and do a &lt;code&gt;GET&lt;/code&gt; of every &lt;code&gt;CurrentVersionURL&lt;/code&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; _ , o &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;range&lt;/span&gt; oi.Offers {
        resp, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; http.Get(&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;https://pricing.us-east-1.amazonaws.com&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;+&lt;/span&gt; o.CurrentVersionURL)
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;h4 id=&#34;and-products&#34;&gt;And products&lt;/h4&gt;

&lt;p&gt;The same principles applies for the products, we decode the stream in an object:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;var&lt;/span&gt; pd productDetails
err = json.NewDecoder(resp.Body).Decode(&lt;span style=&#34;color: #666666&#34;&gt;&amp;amp;&lt;/span&gt;pd)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now that we have all the informations we are ready to store them in the database.&lt;/p&gt;

&lt;h2 id=&#34;storing-the-informations&#34;&gt;Storing the informations&lt;/h2&gt;

&lt;p&gt;As usual with any AWS access, you need to create a &lt;code&gt;session&lt;/code&gt; and a &lt;code&gt;service&lt;/code&gt; object:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;sess, err &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; session.NewSession()
svc &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; dynamodb.New(sess)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/aws/session/&#34;&gt;session&lt;/a&gt; will take care of the credentials by reading the appropriate files or environment variables.&lt;/p&gt;

&lt;p&gt;the &lt;code&gt;svc&lt;/code&gt; object is used to interact with the DynamoDB service. To store an object we will use the method &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/#DynamoDB.PutItem&#34;&gt;PutItem&lt;/a&gt; which takes as argument a reference to &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/#PutItemInput&#34;&gt;PutItemInput&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note&lt;/em&gt; All of the AWS service have the same logic and work the same way: Action takes as a parameter a reference to a type ActionInput and returns a type ActionOutput.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s see how to create a &lt;code&gt;PutItemInput&lt;/code&gt; element from a &lt;code&gt;Product&lt;/code&gt; type.&lt;/p&gt;

&lt;h4 id=&#34;the-dynamodb-item&#34;&gt;the Dynamodb Item&lt;/h4&gt;

&lt;p&gt;The two mandatory fields I will use for the &lt;code&gt;PutItemInput&lt;/code&gt; are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TableName&lt;/code&gt; (which is Product in my case)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Item&lt;/code&gt; (which obviously hold what to store)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Other fields exists, but to be honest, I don&amp;rsquo;t know whether I need them by now.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;Item&lt;/code&gt; expects a map whose key is the field name (In our case it can be &amp;ldquo;SKU&amp;rdquo;, &amp;ldquo;ProductFamily&amp;rdquo; or anything) and whose value is a reference to the special type &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/#AttributeValue&#34;&gt;AttributeValue&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;From the documentation the definition is:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;AttributeValue Represents the data for an attribute. You can set one, and only one, of the elements.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The AttributeValue is &lt;em&gt;typed&lt;/em&gt; (The types are described &lt;a href=&#34;https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_AttributeValue.html&#34;&gt;here&lt;/a&gt;)
Therefore our informations (remember the &lt;code&gt;map[string]inteface{}&lt;/code&gt;) must be &amp;ldquo;convrted&amp;rdquo; to a dynamodb format.
This task has been made easy by using the package &lt;a href=&#34;https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_AttributeValue.html&#34;&gt;dynamodbattribute&lt;/a&gt; which does it for us:&lt;/p&gt;

&lt;p&gt;To fill the item I need to loop for every product in the object &lt;code&gt;pd&lt;/code&gt; and create an item:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;for&lt;/span&gt; k, v &lt;span style=&#34;color: #666666&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;range&lt;/span&gt; pd.Products {
      item[&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;SKU&amp;quot;&lt;/span&gt;], err = dynamodbattribute.Marshal(k)
      item[&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;ProductFamily&amp;quot;&lt;/span&gt;], err = dynamodbattribute.Marshal(v.ProductFamily)
      item[&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;Attributes&amp;quot;&lt;/span&gt;], err = dynamodbattribute.Marshal(v.Attributes)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Once I have an Item, I can create the parameters and send the request to the DB:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;Item:      item,
      TableName: aws.String(config.TableName),
}
&lt;span style=&#34;color: #408080; font-style: italic&#34;&gt;// Now put the item, discarding the result&lt;/span&gt;
_ , err = svc.PutItem(params)
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id=&#34;execution-and-conclusion&#34;&gt;Execution and conclusion&lt;/h1&gt;

&lt;p&gt;Once compiled I can run the program that will take a couple of minute to execute (it can easily be optimized simply by processing each offer in a separate goroutine).
Then I can find the informations in my DB:
&lt;img src=&#34;https://blog.owulveryck.info/assets/images/bigdata/blog-dynamo-result.png&#34; alt=&#34;Result&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Now that I have the informations, on the same principle I can grab the prices and put a little web service in front of it.
And I could even code a little fronted for the service.&lt;/p&gt;

&lt;p&gt;I am aware that if you are not an average go programmer the code may seem tricky, but I can assure you that it is not (the whole example is less than 100 lines long including the comments).
The AWS API seems strange and not idiomatic, but it has the huge advantage to be efficient and coherent.&lt;/p&gt;

&lt;p&gt;Regarding the inventory model. it can be used for any product or even any stock and prices. It is a cheap (and yet efficient) way to manage an inventory.&lt;/p&gt;

&lt;h1 id=&#34;full-code&#34;&gt;Full code&lt;/h1&gt;

&lt;p&gt;The full code of the example can be found on my &lt;a href=&#34;https://gist.github.com/owulveryck/f9665470e8334e8609434feeeddc6071&#34;&gt;gist&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Image reKognition with a webcam, go and AWS.</title>
      <link>https://blog.owulveryck.info/2016/12/16/image-rekognition-with-a-webcam-go-and-aws./index.html</link>
      <pubDate>Fri, 16 Dec 2016 14:51:18 +0100</pubDate>
      
      <guid>https://blog.owulveryck.info/2016/12/16/image-rekognition-with-a-webcam-go-and-aws./index.html</guid>
      <description>

&lt;p&gt;It&amp;rsquo;s been a while since I last posted something. I will fill the gap with a quick post about &lt;em&gt;rekognition&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://aws.amazon.com/rekognition/?nc1=h_ls&#34;&gt;rekognition&lt;/a&gt; is a service from AWS that is described as:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Deep learning-based image recognition&lt;/p&gt;

&lt;p&gt;Search, verify, and organize millions of images&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;In this light post, I will present a simple method to grab a picture from my webcam, send it to rekognition and display the result.&lt;/p&gt;

&lt;p&gt;The part of the result I will focus on is the emotion. In other word, I will ask amazon: &amp;ldquo;An I happy?&amp;rdquo;.&lt;/p&gt;

&lt;h1 id=&#34;getting-the-picture-from-the-webcam&#34;&gt;Getting the picture from the webcam&lt;/h1&gt;

&lt;p&gt;I am using the package &lt;a href=&#34;github.com/blackjack/webcam&#34;&gt;github.com/blackjack/webcam&lt;/a&gt; to grab the picture.&lt;/p&gt;

&lt;h2 id=&#34;capabilities-of-the-webcam-and-image-format&#34;&gt;Capabilities of the webcam and image format&lt;/h2&gt;

&lt;p&gt;My webcam is handling the MJPEG format.
Therefore, after the creation of a &lt;em&gt;cam&lt;/em&gt; object and set the correct settings to grab mjpeg, I can read a frame in JPEG:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// ...
cam, err := webcam.Open(&amp;quot;/dev/video0&amp;quot;) // Open webcam
// ...
// Setting the format:
_,_,_, err := cam.SetImageFormat(format, uint32(size.MaxWidth), uint32(size.MaxHeight))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;format&lt;/code&gt; is of type &lt;code&gt;uint32&lt;/code&gt; and computable thanks to the informations present in &lt;a href=&#34;http://lxr.free-electrons.com/source/include/uapi/linux/videodev2.h&#34;&gt;/usr/include/linux/videodev2.h&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;MJPEG is: 1196444237&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: To be honest, I did not evaluate the FOURCC method; I have requested the supported format of my webcam with their descriptions :)&lt;/p&gt;

&lt;h2 id=&#34;grabbing-the-picture&#34;&gt;Grabbing the picture&lt;/h2&gt;

&lt;p&gt;In a endless &lt;code&gt;for&lt;/code&gt; loop, a frame is read with a call to &lt;code&gt;ReadFrame&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;for {
    timeout := uint32(5) //5 seconds
    err = cam.WaitForFrame(timeout)
    frame, err := cam.ReadFrame()
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;aws&#34;&gt;AWS&lt;/h1&gt;

&lt;p&gt;The API to import to use the service is &lt;code&gt;github.com/aws/aws-sdk-go/service/rekognition&lt;/code&gt; and is documented here: &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/&#34;&gt;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The operation that I am using to detect the emotion is &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/#Rekognition.DetectFaces&#34;&gt;DetectFaces&lt;/a&gt; that takes an pointer to &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/#DetectFacesInput&#34;&gt;DetectFacesInput&lt;/a&gt; with is composed of a pointer to an &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/#Image&#34;&gt;Image&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;creating-the-input&#34;&gt;Creating the input&lt;/h2&gt;

&lt;p&gt;The first thing that needs to be created is the &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/#Image&#34;&gt;Image&lt;/a&gt; object from our &lt;code&gt;frame&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;if len(frame) != 0 {
    image := &amp;amp;rekognition.Image{ // Required
        Bytes: frame,
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we create the DetectFacesInput:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;params := &amp;amp;rekognition.DetectFacesInput{
        Image: image,
        Attributes: []*string{
                aws.String(&amp;quot;ALL&amp;quot;), 
        },
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;ALL&lt;/code&gt; attributes is present, otherwise AWS does not return the complete description of what it has found.&lt;/p&gt;

&lt;h2 id=&#34;sending-the-query&#34;&gt;Sending the query&lt;/h2&gt;

&lt;h3 id=&#34;pricing-notice-and-warning&#34;&gt;Pricing notice and &lt;strong&gt;warning&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;The price of the service as of today is 1 dollar per 1000 request. That sounds cheap, but at 25 FPS, this may cost a lot.
Therefore, I have set up a read request that only process a picture if we press &lt;em&gt;enter&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;bufio.NewReader(os.Stdin).ReadBytes(&#39;\n&#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;session&#34;&gt;Session&lt;/h3&gt;

&lt;p&gt;As usual, to query AWS we need to create a session:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;var err error
sess, err = session.NewSession(&amp;amp;aws.Config{Region: aws.String(&amp;quot;us-east-1&amp;quot;)})
if err != nil {
    fmt.Println(&amp;quot;failed to create session,&amp;quot;, err)
    return
}
svc = rekognition.New(sess)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: The &lt;code&gt;session&lt;/code&gt; library will take care of connections informations such as environment variables like:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;AWS_ACCESS_KEY_ID&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AWS_SECRET_ ACCESS_KEY_ID&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;query-and-result&#34;&gt;Query and result&lt;/h3&gt;

&lt;p&gt;Simply send the query&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;esp, err := svc.DetectFaces(params)

if err != nil {
        fmt.Println(err.Error())
        return
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The result is of type &lt;a href=&#34;http://docs.aws.amazon.com/sdk-for-go/api/service/rekognition/#DetectFacesOutput&#34;&gt;DetectFacesOutput&lt;/a&gt;.
This type is composed of a array of FaceDetails because obviously there can me more than one person per image.
So we will loop and display the emotion for each face detected:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;for i, fd := range resp.FaceDetails {
        fmt.Printf(&amp;quot;The person %v is &amp;quot;, i)
        for _, e := range fd.Emotions {
                fmt.Printf(&amp;quot;%v, &amp;quot;, *e.Type)
        }
        fmt.Printf(&amp;quot;\n&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;run&#34;&gt;Run:&lt;/h1&gt;

&lt;pre&gt;
Resulting image format: MJPEG (320x240)
Press enter to process 
The person 0 is HAPPY, CONFUSED, CALM, 
&lt;/pre&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;That&amp;rsquo;s all folks. The full code can be found &lt;a href=&#34;https://gist.github.com/owulveryck/33753125afa6284cd5dbbb1bd4d1eb54&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the test I made, I was always happy. I&amp;rsquo;ve tried to be angry or sad, without success&amp;hellip; Maybe I have a happy face.
I should try with someone else maybe.&lt;/p&gt;

&lt;p&gt;The service is nice and opens the door to a lot of applications:
For example to monitor my home and sends an alert if someone is in my place and &lt;strong&gt;not from my family&lt;/strong&gt; (or not the cat :).&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>HTTP over UDT for inter-region file transfer</title>
      <link>https://blog.owulveryck.info/2016/10/17/http-over-udt-for-inter-region-file-transfer/index.html</link>
      <pubDate>Mon, 17 Oct 2016 20:50:18 +0200</pubDate>
      
      <guid>https://blog.owulveryck.info/2016/10/17/http-over-udt-for-inter-region-file-transfer/index.html</guid>
      <description>

&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;

&lt;p&gt;Transferring files between server is no big deal with nowadays network equipments.
You use &lt;code&gt;rsync&lt;/code&gt;, &lt;code&gt;scp&lt;/code&gt; or even &lt;code&gt;http&lt;/code&gt; to get a file from A to B.&lt;/p&gt;

&lt;p&gt;Of course, you rely on the TCP stack so you have a decent reliability in the transport.&lt;/p&gt;

&lt;p&gt;But TCP has its drawback, especially when it needs to go through a lot of equipments. Typically in the cloud, or over a VPN.&lt;/p&gt;

&lt;p&gt;To prevent the drawbacks of the TCP protocol, there are several solutions:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Use UDP, but UDP by itself is not &amp;ldquo;reliable&amp;rdquo;&lt;/li&gt;
&lt;li&gt;Develop another layer 4 protocol, but it cannot be done in a pure user space. You need to develop a system driver. It cannot be easily done on a large scale.&lt;/li&gt;
&lt;li&gt;Use UDP and another framework on top of UDP.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;layer-4-udp&#34;&gt;Layer 4: UDP?&lt;/h2&gt;

&lt;p&gt;Yes, UDP, but with an &amp;ldquo;extra&amp;rdquo; layer. I&amp;rsquo;ve had the opportunity to try three of them.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Quic by Google&lt;/li&gt;
&lt;li&gt;FASP by ASPERA&lt;/li&gt;
&lt;li&gt;UDT by Dr GU.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;quic&#34;&gt;Quic&lt;/h3&gt;

&lt;p&gt;First Google, along with its &lt;a href=&#34;https://en.wikipedia.org/wiki/QUIC&#34;&gt;quic&lt;/a&gt; protocol, tries to enhance the user experience. Actually, a quic implementation is already present in chrome and within google web servers. I&amp;rsquo;ve heard about quic at the &lt;a href=&#34;https://dotgo.eu&#34;&gt;dotGo&lt;/a&gt;; &lt;a href=&#34;https://github.com/lucas-clemente&#34;&gt;Lucas Clemente&lt;/a&gt; has presented its work in progress of a quic implementation in GO.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve tried it, but it lacks a client part by now, and the &lt;a href=&#34;https://www.chromium.org/quic/playing-with-quic&#34;&gt;quic tools&lt;/a&gt; from chromium are far from being usable in a production environment.&lt;/p&gt;

&lt;h3 id=&#34;aspera-s-fasp&#34;&gt;Aspera&amp;rsquo;s FASP&lt;/h3&gt;

&lt;p&gt;Aspera has its own protocol. It is based on UDP. I&amp;rsquo;ve seen it running, and yes, it simply works!
The problem is that it is not open source and a bit expensive.&lt;/p&gt;

&lt;h3 id=&#34;the-udt-protocol&#34;&gt;The UDT protocol&lt;/h3&gt;

&lt;p&gt;The UDT protocol is described by ASPERA as its main competitor &lt;a href=&#34;http://asperasoft.com/fileadmin/media/Asperasoft.com/Resources/White_Papers/fasp_Critical_Technology_Comparison_AsperaWP.pdf&#34;&gt;here&lt;/a&gt;.
It&amp;rsquo;s open source and worth the try.
It&amp;rsquo;s the one I will use for my tests.
The code is distributed as a C++ library, but it exists GO bindings.&lt;/p&gt;

&lt;h2 id=&#34;the-layer-7-http&#34;&gt;The Layer 7: HTTP&lt;/h2&gt;

&lt;p&gt;To actually transfer a file, I can use the &lt;code&gt;udtcat&lt;/code&gt; tool provided in the github of go-udtwrapper.
It is ok for a test, but I won&amp;rsquo;t be able to serve multiple files, to resume a transfer etc&amp;hellip; So I need a layer 7 protocol.
HTTP is, according to me, a good choice.&lt;/p&gt;

&lt;h1 id=&#34;the-implementation-in-go&#34;&gt;The implementation in GO&lt;/h1&gt;

&lt;p&gt;Implementing a simple client/server http-over-udt in go is relatively easy. The HTTP is interfaced in a way that the transport can be easily changed.
Therefore, no need to reimplement a complete HTTP stack; GO has all I need in its standard library.&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;img src=&#34;https://blog.owulveryck.info/assets/images/save-princess-go.jpg&#34; alt=&#34;/assets/images/save-princess-go.jpg&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://toggl.com/programming-princess&#34;&gt;https://toggl.com/programming-princess&lt;/a&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;I will use this fork of &lt;a href=&#34;github.com/Lupus/go-udtwrapper&#34;&gt;go-udtwrapper&lt;/a&gt; which seems to be the most up-to-date.&lt;/p&gt;

&lt;h2 id=&#34;the-server&#34;&gt;The server&lt;/h2&gt;

&lt;p&gt;Implementing a basic http server over UDT is very easy.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;https://golang.org/pkg/net/http/#Serve&#34;&gt;Serve function&lt;/a&gt; from the http package takes a &lt;code&gt;net.Listener&lt;/code&gt; as argument.
The &lt;code&gt;udt.Listen&lt;/code&gt; function implements the &lt;a href=&#34;https://golang.org/pkg/net/#Listener&#34;&gt;net.Listener&lt;/a&gt; interface.&lt;/p&gt;

&lt;p&gt;Therefore we can simply use this code to serve HTTP content via the DefaultMuxer over udt:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;ln, _ := udt.Listen(&amp;quot;udt&amp;quot;, config.Addr)
http.Serve(ln, nil)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A full implementation that serves local file is simply done by:&lt;/p&gt;

&lt;script src=&#34;//gist.github.com/owulveryck/6a44885c2b3527159f496c21071ab8df.js?file=server.go&#34;&gt;&lt;/script&gt;

&lt;h2 id=&#34;the-client&#34;&gt;The client&lt;/h2&gt;

&lt;p&gt;The &lt;code&gt;http.Client&lt;/code&gt;&amp;rsquo;s DefautTransport relies on TCP.
Therefore we must completely rewrite a Transport to use UDT.&lt;/p&gt;

&lt;p&gt;The Transport entry of the Client implements the RoundTripper interface.&lt;/p&gt;

&lt;p&gt;The key point is to write a client transport for UDT that implements the RoundTripper interface.&lt;/p&gt;

&lt;h3 id=&#34;the-http-roundtripper-interface&#34;&gt;The http.RoundTripper interface&lt;/h3&gt;

&lt;p&gt;Here is an example of an implementation:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// UdtClient implements the http.RoundTripper interface
type udtClient struct{}

func (c udtClient) RoundTrip(r *http.Request) (*http.Response, error) {
      d := udt.Dialer{}
      conn, err := d.Dial(&amp;quot;udt&amp;quot;, r.URL.Host)
      if err != nil {
          return nil, err
      }
      err = r.Write(conn)
      if err != nil {
          return nil, err
      }
      return http.ReadResponse(bufio.NewReader(conn), r)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;the-full-client-code&#34;&gt;The full client code&lt;/h3&gt;

&lt;p&gt;A simple client that will perform a GET operation on our server would be:&lt;/p&gt;

&lt;script src=&#34;//gist.github.com/owulveryck/6a44885c2b3527159f496c21071ab8df.js?file=client.go&#34;&gt;&lt;/script&gt;

&lt;h3 id=&#34;building-the-tools&#34;&gt;Building the tools&lt;/h3&gt;

&lt;p&gt;As we rely on CGO, to do a static compilation, we must use the extra flags: &lt;code&gt;go build --ldflags &#39;-extldflags &amp;quot;-static&amp;quot;&#39;&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;This is a very basic implementation of http over UDT.
I have developed a more complete tool for my client, but it cannot be published in open source.&lt;/p&gt;

&lt;p&gt;Among the things that I have done there are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Gzip compression&lt;/li&gt;
&lt;li&gt;Partial content for resuming a broken download (with http.ServeContent)&lt;/li&gt;
&lt;li&gt;SHA256 checking at the end of the transport&lt;/li&gt;
&lt;li&gt;an HTTP middleware (Rest API) to query the transfer states, rates and efficiency via the PerfMon interface&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What&amp;rsquo;s not done yet:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TLS and mutual authentication&lt;/li&gt;
&lt;li&gt;good benchmarks to actually measure the performances of UDT.&lt;/li&gt;
&lt;li&gt;Downloading chunks to optimize the speed of transfer and the bandwith usage&lt;/li&gt;
&lt;li&gt;maybe a POST method to upload a file in multipart&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Getting weather data from the station to the raspberry</title>
      <link>https://blog.owulveryck.info/2016/08/29/getting-weather-data-from-the-station-to-the-raspberry/index.html</link>
      <pubDate>Mon, 29 Aug 2016 21:58:17 +0200</pubDate>
      
      <guid>https://blog.owulveryck.info/2016/08/29/getting-weather-data-from-the-station-to-the-raspberry/index.html</guid>
      <description>

&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;

&lt;p&gt;A bunch of friends/colleagues offered me a &lt;a type=amzn&gt;raspberry pi 3&lt;/a&gt;.
It may become my VPN gateway, or my firewall, or the brain of my CCTV, or maybe the center of an alarm&amp;hellip;. Maybe a spotify player&amp;hellip;&lt;/p&gt;

&lt;p&gt;Anyway, I have installed raspbian and I&amp;rsquo;m now playing with it.&lt;/p&gt;

&lt;p&gt;Yesterday evening, as I was about to go to bed, I&amp;rsquo;ve had a very bad idea&amp;hellip; I&amp;rsquo;ve linked together my &lt;a type=amzn&gt;rpi&lt;/a&gt; and my &lt;a type=&#34;amzn&#34;&gt;Oregon&lt;/a&gt; Weather Station.
3 hours later, I was still geeking&amp;hellip;&lt;/p&gt;

&lt;p&gt;As usual in the blog I will explain what I did, what did work, and what did not.&lt;/p&gt;

&lt;h1 id=&#34;attaching-the-devices&#34;&gt;Attaching the devices&lt;/h1&gt;

&lt;p&gt;I&amp;rsquo;ve plugged the device, ok! Now what does the system tells me about it:&lt;/p&gt;

&lt;p&gt;What &lt;code&gt;dmesg&lt;/code&gt; tells me is simply&lt;/p&gt;

&lt;pre&gt;
[ 2256.877522] usb 1-1.4: new low-speed USB device number 5 using dwc_otg
[ 2256.984860] usb 1-1.4: New USB device found, idVendor=0fde, idProduct=ca01
[ 2256.984881] usb 1-1.4: New USB device strings: Mfr=0, Product=1, SerialNumber=0
[ 2256.984894] usb 1-1.4: Product:  
[ 2256.992719] hid-generic 0003:0FDE:CA01.0002: hiddev0,hidraw0: USB HID v1.10 Device [ ] on usb-3f980000.usb-1.4/input0
&lt;/pre&gt;

&lt;h2 id=&#34;finding-the-device&#34;&gt;Finding the device&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;lsusb&lt;/code&gt; gives me the list of the usb devices on my &lt;a type=amzn&gt;rpi&lt;/a&gt;:&lt;/p&gt;

&lt;pre&gt;
# lsusb 
Bus 001 Device 004: ID 0fde:ca01  
Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp. SMSC9512/9514 Fast Ethernet Adapter
Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp. 
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
&lt;/pre&gt;

&lt;p&gt;The first one correspond to my weather station but it belongs to root:&lt;/p&gt;

&lt;pre&gt;
# ls -lrt /dev/bus/usb/001/004
crw------- 1 root root 189, 3 Aug 30 12:45 /dev/bus/usb/001/004
&lt;/pre&gt;

&lt;h2 id=&#34;giving-access-udev&#34;&gt;Giving access: &lt;code&gt;udev&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;The first thing to do is to allow access to my usb device so I won&amp;rsquo;t need to run any program as root.
By default the &lt;code&gt;pi&lt;/code&gt; user belongs to a bunch of groups. One of those is called &lt;code&gt;plugdev&lt;/code&gt;.
It is the one I will use for my experiment.&lt;/p&gt;

&lt;h3 id=&#34;get-information-about-my-device&#34;&gt;Get information about my Device&lt;/h3&gt;

&lt;pre&gt;
# udevadm info /dev/bus/usb/001/004

P: /devices/platform/soc/3f980000.usb/usb1/1-1/1-1.3
N: bus/usb/001/012
E: BUSNUM=001
E: DEVNAME=/dev/bus/usb/001/012
E: DEVNUM=012
E: DEVPATH=/devices/platform/soc/3f980000.usb/usb1/1-1/1-1.3
E: DEVTYPE=usb_device
E: DRIVER=usb
E: ID_BUS=usb
E: ID_MODEL_ENC=\x20
E: ID_MODEL_FROM_DATABASE=WMRS200 weather station
E: ID_MODEL_ID=ca01
E: ID_REVISION=0302
E: ID_SERIAL=0fde_
E: ID_USB_INTERFACES=:030000:
E: ID_VENDOR=0fde
E: ID_VENDOR_ENC=0fde
E: ID_VENDOR_FROM_DATABASE=Oregon Scientific
E: ID_VENDOR_ID=0fde
E: MAJOR=189
E: MINOR=11
E: PRODUCT=fde/ca01/302
E: SUBSYSTEM=__usb__
E: TYPE=0/0/0
E: USEC_INITIALIZED=5929384
&lt;/pre&gt;

&lt;p&gt;I will note the vendor ID and the product ID.
Funny stuff is that it presents itself as a WMRS200 and the model I have is a RMS300, but never mind.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s create the udev rule file using the previous informations about the idVendor and the idProduct and create a special file &lt;code&gt;/dev/weather-station&lt;/code&gt;.
This will make the code more easy as I will be able to hard code the name, and leave the boring task of finding the device aside.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/udev/rules.d/50-weather-station.rules
# Weather Station
SUBSYSTEM==&amp;quot;usb&amp;quot;, ATTRS{idVendor}==&amp;quot;0fde&amp;quot;, ATTRS{idProduct}==&amp;quot;ca01&amp;quot;, MODE=&amp;quot;0660&amp;quot;, GROUP=&amp;quot;plugdev&amp;quot;, SYMLINK+=&amp;quot;weather-station&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once done, I can restart udev with &lt;code&gt;sudo /etc/init.d/udev restart&lt;/code&gt; or reload and trigger the rules with &lt;code&gt;udevadm&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;IF something goes wrong, you can check the logs by turning the log level to info, reload the rules and look into the syslog file&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# udevadm control -l info
# udevadm control -R
# # grep -i udev /var/log/syslog 
# 
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;# ls -lrt /dev/weather-station                                                                                                               
lrwxrwxrwx 1 root root 15 Aug 29 21:32 /dev/weather-station -&amp;gt; bus/usb/001/007
# ls -lrt /dev/bus/usb/001/007                                                                                                   
crw-rw-r-- 1 root plugdev 189, 6 Aug 29 21:32 /dev/bus/usb/001/007
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So far so good&amp;hellip;&lt;/p&gt;

&lt;h1 id=&#34;accessing-the-data&#34;&gt;Accessing the data&lt;/h1&gt;

&lt;h2 id=&#34;the-libusb&#34;&gt;The libusb&lt;/h2&gt;

&lt;p&gt;Linux has a low level library &amp;ldquo;libusb&amp;rdquo; that make the development of modules easy: &lt;a href=&#34;http://www.libusb.org/wiki/libusb-1.0&#34;&gt;libusb-1.0&lt;/a&gt;.
On my &lt;a type=amzn&gt;rpi&lt;/a&gt;, I can install the development version with a simple &lt;code&gt;sudo apt-get install libusb-1.0-0-dev&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;using-go-the-gousb-library&#34;&gt;Using GO: The &lt;code&gt;gousb&lt;/code&gt; library&lt;/h2&gt;

&lt;p&gt;A binding for the libusb is available through the &lt;a href=&#34;https://github.com/truveris/gousb&#34;&gt;gousb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is also a &lt;strong&gt;lsusb&lt;/strong&gt; version that is available as an example.
Let&amp;rsquo;s grab it with a simple
&lt;code&gt;go get -v github.com/kylelemons/gousb/lsusb&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;and test it&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# ~GOPATH/bin/lsusb

001.004 0fde:ca01 WMRS200 weather station (Oregon Scientific)
  Protocol: (Defined at Interface level)
  Config 01:
    --------------
    Interface 00 Setup 00
      Human Interface Device (No Subclass) None
      Endpoint 1 IN  interrupt - unsynchronized data [8 0]
    --------------
001.003 0424:ec00 SMSC9512/9514 Fast Ethernet Adapter (Standard Microsystems Corp.)
  Protocol: Vendor Specific Class
  Config 01:
    --------------
    Interface 00 Setup 00
      Vendor Specific Class
      Endpoint 1 IN  bulk - unsynchronized data [512 0]
      Endpoint 2 OUT bulk - unsynchronized data [512 0]
      Endpoint 3 IN  interrupt - unsynchronized data [16 0]
    --------------
001.002 0424:9514 SMC9514 Hub (Standard Microsystems Corp.)
  Protocol: Hub (Unused) TT per port
  Config 01:
    --------------
    Interface 00 Setup 00
      Hub (Unused) Single TT
      Endpoint 1 IN  interrupt - unsynchronized data [1 0]
    Interface 00 Setup 01
      Hub (Unused) TT per port
      Endpoint 1 IN  interrupt - unsynchronized data [1 0]
    --------------
001.001 1d6b:0002 2.0 root hub (Linux Foundation)
  Protocol: Hub (Unused) Single TT
  Config 01:
    --------------
    Interface 00 Setup 00
      Hub (Unused) Full speed (or root) hub
      Endpoint 1 IN  interrupt - unsynchronized data [4 0]
  --------------
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;rawread&#34;&gt;Rawread&lt;/h2&gt;

&lt;p&gt;I want to read the raw data from the device.
The gousb package comes along with an example named &amp;ldquo;rawread&amp;rdquo;. I&amp;rsquo;m using it:&lt;/p&gt;

&lt;pre&gt;
# rawread git:(master) # go run main.go -device &#34;0fde:ca01&#34;
2016/08/30 14:00:01 Scanning for device &#34;0fde:ca01&#34;...
  Protocol: (Defined at Interface level)
  Config 01:
    --------------
    Interface 00 Setup 00
      Human Interface Device (No Subclass) None
      Endpoint 1 IN  interrupt - unsynchronized data [8 0]
    --------------
2016/08/30 14:00:01 Connecting to endpoint...
2016/08/30 14:00:01 - &amp;usb.Descriptor{Bus:0x1, Address:0x4, Spec:0x110, Device:0x302, Vendor:0xfde, Product:0xca01, Class:0x0, SubClass:0x0, Protocol:0x0, Configs:[]usb.ConfigInfo{usb.ConfigInfo{Config:0x1, Attributes:0x80, MaxPower:0x32, Interfaces:[]usb.InterfaceInfo{usb.InterfaceInfo{Number:0x0, Setups:[]usb.InterfaceSetup{usb.InterfaceSetup{Number:0x0, Alternate:0x0, IfClass:0x3, IfSubClass:0x0, IfProtocol:0x0, Endpoints:[]usb.EndpointInfo{usb.EndpointInfo{Address:0x81, Attributes:0x3, MaxPacketSize:0x8, MaxIsoPacket:0x0, PollInterval:0xa, RefreshRate:0x0, SynchAddress:0x0}}}}}}}}}
2016/08/30 14:00:01 open: usb: claim: libusb: device or resource busy [code -6]
&lt;/pre&gt;

&lt;p&gt;After digging into the documentation and forums about the libusb, it looks like the device is locked by a generic kernel driver.
So I need to detach it first.&lt;/p&gt;

&lt;p&gt;The API call used to detach a kernel driver is &lt;code&gt;libusb_detach_kernel_driver&lt;/code&gt;. Sadly it has not be bound to the golang&amp;rsquo;s library.
Indeed &lt;a href=&#34;https://github.com/jpoirier&#34;&gt;Joseph Poirier&lt;/a&gt; maintain an active fork from the gousb library and he does implement the call.
It&amp;rsquo;s a private method that is called implicitly by another call, so no need to modify the code from rawread to use it.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve switched to his version:&lt;/p&gt;

&lt;pre&gt;
# go get github.com/jpoirier/gousb/rawread
./main -device &#34;0fde:ca01&#34;
2016/08/30 14:12:28 Scanning for device &#34;0fde:ca01&#34;...
  Protocol: (Defined at Interface level)
  Config 01:
    --------------
    Interface 00 Setup 00
      Human Interface Device (No Subclass) None
      Endpoint 1 IN  interrupt - unsynchronized data [8 0]
    --------------
2016/08/30 14:12:28 Connecting to endpoint...
2016/08/30 14:12:28 - &amp;usb.Descriptor{Bus:0x1, Address:0x4, Spec:0x110, Device:0x302, Vendor:0xfde, Product:0xca01, Class:0x0, SubClass:0x0, Protocol:0x0, Configs:[]usb.ConfigInfo{usb.ConfigInfo{Config:0x1, Attributes:0x80, MaxPower:0x32, Interfaces:[]usb.InterfaceInfo{usb.InterfaceInfo{Number:0x0, Setups:[]usb.InterfaceSetup{usb.InterfaceSetup{Number:0x0, Alternate:0x0, IfClass:0x3, IfSubClass:0x0, IfProtocol:0x0, Endpoints:[]usb.EndpointInfo{usb.EndpointInfo{Address:0x81, Attributes:0x3, MaxPacketSize:0x8, MaxIsoPacket:0x0, PollInterval:0xa, RefreshRate:0x0, SynchAddress:0x0}}}}}}}}}
&lt;/pre&gt;

&lt;p&gt;Nothing more because the code ends by&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;  ep, err := dev.OpenEndpoint(uint8(*config), uint8(*iface), uint8(*setup), uint8(*endpoint)|uint8(usb.ENDPOINT_DIR_IN))
  if err != nil {
      log.Fatalf(&amp;quot;open: %s&amp;quot;, err)
  }
  _ = ep 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cool&amp;hellip; Now let&amp;rsquo;s add some code to read from the endpoint (which is an interface and that implements a Read method as described &lt;a href=&#34;https://godoc.org/github.com/jpoirier/gousb/usb#Endpoint&#34;&gt;here&lt;/a&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;  b := make([]byte, 16)
  _, err = ep.Read(b)
  if err != nil {
      log.Fatalf(&amp;quot;read: %s&amp;quot;, err)
  }
  log.Printf(&amp;quot;%v&amp;quot;, b)
  _ = ep 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And run the code:&lt;/p&gt;

&lt;pre&gt;
go run main.go -device &#34;0fde:ca01&#34;
2016/08/30 14:25:58 Scanning for device &#34;0fde:ca01&#34;...
  Protocol: (Defined at Interface level)
    Config 01:
    --------------
    Interface 00 Setup 00
      Human Interface Device (No Subclass) None
      Endpoint 1 IN  interrupt - unsynchronized data [8 0]
    --------------
2016/08/30 14:25:58 Connecting to endpoint...
2016/08/30 14:25:58 - &amp;usb.Descriptor{Bus:0x1, Address:0x4, Spec:0x110, Device:0x302, Vendor:0xfde, Product:0xca01, Class:0x0, SubClass:0x0, Protocol:0x0, Configs:[]usb.ConfigInfo{usb.ConfigInfo{Config:0x1, Attributes:0x80, MaxPower:0x32, Interfaces:[]usb.InterfaceInfo{usb.InterfaceInfo{Number:0x0, Setups:[]usb.InterfaceSetup{usb.InterfaceSetup{Number:0x0, Alternate:0x0, IfClass:0x3, IfSubClass:0x0, IfProtocol:0x0, Endpoints:[]usb.EndpointInfo{usb.EndpointInfo{Address:0x81, Attributes:0x3, MaxPacketSize:0x8, MaxIsoPacket:0x0, PollInterval:0xa, RefreshRate:0x0, SynchAddress:0x0}}}}}}}}}
2016/08/30 14:25:59 [7 0 48 0 48 53 1 255 7 255 0 66 129 239 0 32]
&lt;/pre&gt;

&lt;p&gt;OK! Here are the data, now what I need to figure out, is how to interpret them!&lt;/p&gt;

&lt;h2 id=&#34;decoding-the-protocol&#34;&gt;Decoding the Protocol&lt;/h2&gt;

&lt;p&gt;Internet is a great tool: I&amp;rsquo;ve found a description of the protocol &lt;a href=&#34;http://www.bashewa.com/wmr200-protocol.php&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve read that it was mandatory to send a heartbeat sequence every 30 seconds.
I will implement the heartbeat later. For now I will send it initially to request data from the station:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// This is a hearbeat request (9 bytes array)
h := []byte{0x00, 0x01, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
log.Println(&amp;quot;Sending heartbeat&amp;quot;)
i, err := ep.Write(h)
if err != nil {
    log.Fatal(&amp;quot;Cannot send heartbeat&amp;quot;, err)
}
log.Println(&amp;quot;%v bytes sent&amp;quot;,i)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then read the stream back. Every data payload is separate from the others by a 0xffff sequence.&lt;/p&gt;

&lt;h3 id=&#34;testing-the-sequence-initialization-request&#34;&gt;Testing the sequence initialization request&lt;/h3&gt;

&lt;pre&gt;
 go run main.go -device &#34;0fde:ca01&#34;
2016/08/30 20:02:19 Scanning for device &#34;0fde:ca01&#34;...
Protocol: (Defined at Interface level)
  Config 01:
  --------------
  Interface 00 Setup 00
    Human Interface Device (No Subclass) None
    Endpoint 1 IN  interrupt - unsynchronized data [8 0]
  --------------
  2016/08/30 20:02:19 Connecting to endpoint...
2016/08/30 20:02:19 Sending heartbeat
2016/08/30 20:02:19 heartbeat failed: usb: write: not an OUT endpoint
&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;What did² I do wrong?&lt;/strong&gt;
&lt;center&gt;
&lt;img src=&#34;http://imgs.xkcd.com/comics/debugging.png&#34; alt=&#34;XKCD&#34; /&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;Easy, I didn&amp;rsquo;t RTFM&amp;hellip;
Actually, I didn&amp;rsquo;t read the specification of the USB.&lt;/p&gt;

&lt;p&gt;As described &lt;a href=&#34;http://events.linuxfoundation.org/sites/events/files/slides/elc_2014_usb_0.pdf&#34;&gt;here&lt;/a&gt; the USB is a &lt;strong&gt;host-controlled&lt;/strong&gt; bus which means that:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Nothing on the bus happens without the host first initiating it.&lt;/li&gt;
&lt;li&gt;Devices cannot initiate a transaction.&lt;/li&gt;
&lt;li&gt;The USB is a Polled Bus&lt;/li&gt;
&lt;li&gt;The Host polls each device, requesting data or sending data&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The possibles transaction are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;IN : Device to Host&lt;/li&gt;
&lt;li&gt;OUT: Host to Device&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On top of that, a device may handle 1 to N configuration which handles 1 to N endpoints which may be considered IN or OUT.&lt;/p&gt;

&lt;p&gt;My weather station has only one endpoint which is IN.
Therefore I will not be able to send information to the station from the host. What I will be able to send is a IN token to get data on the bus.&lt;/p&gt;

&lt;pre&gt;
# lsusb -v
...
Endpoint Descriptor:
  bLength                 7
  bDescriptorType         5
  bEndpointAddress     0x81  EP 1 IN
  bmAttributes            3
    Transfer Type            Interrupt
    Synch Type               None
    Usage Type               Data
  wMaxPacketSize     0x0008  1x 8 bytes
  bInterval              10
&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt; I also see that the endpoint is an interrupt&lt;/p&gt;

&lt;h1 id=&#34;to-be-continued&#34;&gt;To be continued&amp;hellip;&lt;/h1&gt;

&lt;p&gt;This blog post is quiet long, and I haven&amp;rsquo;t finished my research yet. Indeed I think that there is enough information for the post to go live.
I will post a part II as soon as I will have time to continue my experiments with the USB device and the &lt;a type=amzn&gt;rpi&lt;/a&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Websockets, Reveal.js, D3 and GO for a dynamic keynote</title>
      <link>https://blog.owulveryck.info/2016/06/23/websockets-reveal.js-d3-and-go-for-a-dynamic-keynote/index.html</link>
      <pubDate>Thu, 23 Jun 2016 15:32:54 +0200</pubDate>
      
      <guid>https://blog.owulveryck.info/2016/06/23/websockets-reveal.js-d3-and-go-for-a-dynamic-keynote/index.html</guid>
      <description>

&lt;h1 id=&#34;the-goal&#34;&gt;the goal&lt;/h1&gt;

&lt;p&gt;As all my peers, I have the opportunity to talk about different technological aspects.
As all my peers, I&amp;rsquo;m asked to present a bunch of slides (powerpoint or keynote, or whatever).&lt;/p&gt;

&lt;p&gt;In this post I won&amp;rsquo;t dig into what&amp;rsquo;s good or not to put in a presentation, and if that&amp;rsquo;s what interest you, I
recommend you to take a look at &lt;a href=&#34;http://www.presentationzen.com/&#34;&gt;Garr Reynold&amp;rsquo;s tips and tricks&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Steve Jobs&lt;/em&gt; said:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;People who knows what they&amp;rsquo;re talking about don&amp;rsquo;t need PowerPoint&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;(actually it has been quoted in Walter Isaacson&amp;rsquo;s biography see &lt;a href=&#34;http://blog.jgc.org/2011/11/people-who-know-what-theyre-talking.html&#34;&gt;this reference&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;As an attendee I tend to agree; usually PowerPoints are boring and they hardly give any interest besides for the writer to say &amp;ldquo;hey look, I&amp;rsquo;ve worked for this presentation&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;Indeed, they are a must. So for my next presentation I thought:&lt;/p&gt;

&lt;p&gt;wouldn&amp;rsquo;t it be nice to use this wide display area to make the presentation more interactive.
One of the key point in communication is to federate people. So what if people could get represented for real in the presentation.&lt;/p&gt;

&lt;h2 id=&#34;how-to-the-architecture&#34;&gt;how to: the architecture&lt;/h2&gt;

&lt;p&gt;Obviously I cannot use conventional tools, such as PowerPoint, Keynote, Impress, google slides and so.
I need something that I can program; something that can interact with a server, and something that is not a console so I can get
fancy and eye-candy animations.&lt;/p&gt;

&lt;h3 id=&#34;the-basic&#34;&gt;The basic&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://lab.hakim.se/reveal-js/&#34;&gt;reveal.js&lt;/a&gt; is an almost perfect candidate:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;it is a framework written in JavaScript therefore, I can easily ass code&lt;/li&gt;
&lt;li&gt;it&amp;rsquo;s well designed&lt;/li&gt;
&lt;li&gt;it can be used alongside with any other JavaScript framework&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;graphs-animations-etc&#34;&gt;Graphs, animations, etc&amp;hellip;&lt;/h3&gt;

&lt;p&gt;A good presentation has animations, graphs, diagrams, and stuffs that cannot be expressed simply with words.
I will interact with the audience. I will explain how later, but anyway they will send me some data.
I could process them in whatever server-side application (php, go-template base, python) but I have the feeling that&amp;rsquo;s not
the idiomatic way of doing modern web content. Actually, I would need anyway to deal with device (mobile, desktop), screen size,
browser&amp;hellip; So what&amp;rsquo;s best, I think, is to get the data on the client side and process it via Javascript.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://d3js.org/&#34;&gt;Data Driver Documents&lt;/a&gt; is the framework I will use to process and display the data I will get from the client.&lt;/p&gt;

&lt;p&gt;It actually uses SVG to represent the graphs; I would have liked to use a full HTML5 to be more&amp;hellip; 2016, but the D3 is actually very very good
framework I wanted to use for a while.&lt;/p&gt;

&lt;h3 id=&#34;the-attendees&#34;&gt;The attendees&lt;/h3&gt;

&lt;p&gt;If I want the attendees to participate they need a device, to act as a client.
About all people I will talk to have a smartphone; that is what I will use.&lt;/p&gt;

&lt;p&gt;It has two advantages:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;it is their own device, I looks more realistic and unexpected: therefore I would get a better reception of the message I&amp;rsquo;m trying to pass.&lt;/li&gt;
&lt;li&gt;it usually has a Webkit based web browser with a decent Javascript engine.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I won&amp;rsquo;t develop a native app, instead I will a webpage mobile compliant based on the &lt;a href=&#34;http://getbootstrap.com/&#34;&gt;bootstrap&lt;/a&gt; framework.&lt;/p&gt;

&lt;h3 id=&#34;the-hub&#34;&gt;The HUB&lt;/h3&gt;

&lt;p&gt;The point now, is how to make my clients and my presentation to exchange data.
As I said before, I would not be an easy task to setup a pure browser based peer-to-peer communication, so I will fall
back to the traditional web server based hub.&lt;/p&gt;

&lt;p&gt;the first idea is to use a RESTfull mechanism, but this has the major disadvantage of not being real-timed.
What I would like is a communication HUB that would broadcast events as soon as they are reveived.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve implemented a server in go to do so. The clients will talk to the server over websockets which are now natively present in every
modern browsers.&lt;/p&gt;

&lt;h4 id=&#34;the-server&#34;&gt;the server&lt;/h4&gt;

&lt;p&gt;I&amp;rsquo;ve used the &lt;a href=&#34;https://github.com/gorilla/websocket&#34;&gt;Implementation from gorilla&lt;/a&gt; because it seemed to be the best as of today.
It implements all the RFC and the development is up-to-date.&lt;/p&gt;

&lt;p&gt;The code heavily relies on channels to broadcast the messages between the different peers.
 I&amp;rsquo;ve taken the chat example present in the gorilla&amp;rsquo;s package.&lt;/p&gt;

&lt;p&gt;At first I did code all the mechanism is a simple go package. After a bunch of code, I&amp;rsquo;ve decided to split the code into two different
projects: The main presentation and the &lt;a href=&#34;http://github.com/owulveryck/gowmb&#34;&gt;gowmb&lt;/a&gt;. The gowmb package is usable in others projects.&lt;/p&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion.&lt;/h1&gt;

&lt;p&gt;I don&amp;rsquo;t go into the implementation details in this post, instead I will refer to the &lt;a href=&#34;https://github.com/owulveryck/topology-presentation&#34;&gt;github&lt;/a&gt;
repository where the presentation is hosted.&lt;/p&gt;

&lt;p&gt;By now I have a good animated slideshow, and the ability to join the slides with a mobile phone.
I can also draw a topology of the attendees via D3 and interact with them.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Orchestrate a digraph with goroutine, a concurrent orchestrator</title>
      <link>https://blog.owulveryck.info/2015/12/02/orchestrate-a-digraph-with-goroutine-a-concurrent-orchestrator/index.html</link>
      <pubDate>Wed, 02 Dec 2015 14:24:21 +0000</pubDate>
      
      <guid>https://blog.owulveryck.info/2015/12/02/orchestrate-a-digraph-with-goroutine-a-concurrent-orchestrator/index.html</guid>
      <description>

&lt;p&gt;I&amp;rsquo;ve read a lot about graph theory recently.
They have changed the world a lot. From the simple representation to Bayesian network via Markov chains, the applications are numerous.&lt;/p&gt;

&lt;p&gt;Today I would like to imagine a graph as a workflow of execution. Every node would be considered as runnable. And every  edge would be a dependency.&lt;/p&gt;

&lt;p&gt;It is an important framework that may be used to as an orchestrator for any model, and of course I am a lot thinkingabout &lt;strong&gt;TOSCA&lt;/strong&gt;&lt;/p&gt;

&lt;h1 id=&#34;the-use-case&#34;&gt;The use case&lt;/h1&gt;

&lt;p&gt;If we consider this very simple graph (example taken from the french wikipedia page)&lt;/p&gt;

&lt;p&gt;&lt;img class=&#34;img-responsive&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph1.png&#34; alt=&#34;digraph example&#34;/&gt;&lt;/p&gt;

&lt;p&gt;its corresponding adjacency matrix is:&lt;/p&gt;

&lt;p&gt;&lt;img class=&#34;img-responsive&#34; src=&#34;https://blog.owulveryck.info/assets/images/matrix1.png&#34; alt=&#34;Adjacency matrix&#34;/&gt;&lt;/p&gt;

&lt;p&gt;its dimension is 8x8&lt;/p&gt;

&lt;p&gt;For the lab, I will consider that each node has to do a simple task which is to wait for a random number of millisecond (such as Rob Pike&amp;rsquo;s &lt;em&gt;boring&lt;/em&gt; function, see references)&lt;/p&gt;

&lt;h1 id=&#34;let-s-go&#34;&gt;Let&amp;rsquo;s GO&lt;/h1&gt;

&lt;h2 id=&#34;how-will-it-work&#34;&gt;How will it work&lt;/h2&gt;

&lt;p&gt;Every node will be run in a &lt;code&gt;goroutine&lt;/code&gt;. That is a point. But how do I deal with concurrency ?&lt;/p&gt;

&lt;p&gt;Every single goroutine will be initially launched and then wait for an information.&lt;/p&gt;

&lt;p&gt;It will have an input communication channel, and a &lt;em&gt;conductor&lt;/em&gt; will feed this channel with enough information for the goroutine to decides whether it should run or not.
This information is simply the adjacency matrix up-to-date. That means that is a node is done, its value is set to zero.&lt;/p&gt;

&lt;p&gt;Every goroutine will then check in the adjacency matrix, whether it has predecessor (that means if the corresponding vector is null, or every digit in column N is 0) and therefore will execute the step or not.&lt;/p&gt;

&lt;p&gt;Once the execution of task is over, the goroutine will then feed another channel to tell the conductor that its job is done. and then the conductor will broadcast the information.&lt;/p&gt;

&lt;h3 id=&#34;example&#34;&gt;Example&lt;/h3&gt;

&lt;p&gt;In our example, nodes &lt;em&gt;3&lt;/em&gt;, &lt;em&gt;5&lt;/em&gt;, and &lt;em&gt;7&lt;/em&gt; do not have any predecessor, so they will be able to run first.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(1)&lt;/strong&gt; The conductors feed the nodes with the matrix&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step1.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step1.png&#34; alt=&#34;digraph example&#34;/&gt;&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(2)&lt;/strong&gt; Every node get the data and analyse the matrix&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step2.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step2.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(3)&lt;/strong&gt; Nodes 3, 5 and 7 have no predecessor (their column in the matrix sums to zero): they can run&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step3.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step3.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(4)&lt;/strong&gt; Nodes 3 and 5 are done, they informs the conductor&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step4.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step4.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(5)&lt;/strong&gt; conductor update the matrix. It fills the rows 3 and 5 with zeros (actually rows 4 and 6, because our first node is 0)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step5.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step5.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(6)&lt;/strong&gt; The conductor feeds the nodes with the matrix&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step6.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step6.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(7)&lt;/strong&gt; The nodes analyse the matrix&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step7.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step7.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(8)&lt;/strong&gt; Node 2 can run&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.owulveryck.info/assets/orchestrate-a-digraph-with-goroutine/digraph_step8.dot&#34;&gt;&lt;img class=&#34;img-responsive img-thumbnail&#34; src=&#34;https://blog.owulveryck.info/assets/images/digraph_step8.png&#34; alt=&#34;digraph example&#34;/&gt; &lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;the-representation-of-the-use-case-in-go&#34;&gt;The representation of the use case in go&lt;/h2&gt;

&lt;h3 id=&#34;data-representation&#34;&gt;Data representation&lt;/h3&gt;

&lt;p&gt;to keep it simple, I won&amp;rsquo;t use a &lt;code&gt;list&lt;/code&gt; or a &lt;code&gt;slice&lt;/code&gt; to represent the matrix, but instead I will rely on the &lt;a href=&#34;https://godoc.org/github.com/gonum/matrix/mat64&#34;&gt;package mat64&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;A slice may be more efficient, but by now it is not an issue.&lt;/p&gt;

&lt;p&gt;On top of that, I may need later to transpose or look for eigenvalues, and this package does implement the correct method to do so.
For clarity of the description, I didn&amp;rsquo;t use a &lt;code&gt;float64&lt;/code&gt; array to initialize the matrix.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;// Allocate a zeroed array of size 8×8
m := mat64.NewDense(8, 8, nil)
m.Set(0, 1, 1); m.Set(0, 4, 1) // First row
m.Set(1, 6, 1); m.Set(1, 6, 1) // second row
m.Set(3, 2, 1); m.Set(3, 6, 1) // fourth row
m.Set(5, 0, 1); m.Set(5, 1, 1); m.Set(5, 2, 1) // fifth row
m.Set(7, 6, 1) // seventh row
fa := mat64.Formatted(m, mat64.Prefix(&amp;quot;    &amp;quot;))
fmt.Printf(&amp;quot;\nm = %v\n\n&amp;quot;, fa)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;the-node-execution-function-run&#34;&gt;The node execution function (&lt;em&gt;run&lt;/em&gt;)&lt;/h3&gt;

&lt;p&gt;The node execution is performed by a &lt;code&gt;run&lt;/code&gt; function that takes two arguments:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The ID of the node&lt;/li&gt;
&lt;li&gt;The duration of the sleep it performs&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This function returns a channel that will be used to exchange a &lt;code&gt;Message&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;func run(id int, duration time.Duration) &amp;lt;-chan Message { }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A &lt;code&gt;Message&lt;/code&gt; is a structure that will holds:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;the id of the node who have issued the message&lt;/li&gt;
&lt;li&gt;a boolean which act as a flag that says whether it has already run&lt;/li&gt;
&lt;li&gt;a wait channel which take a matrix as argument. This channel acts as the communication back mechanism from the conductor to the node&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;type Message struct {
	id   int
	run  bool
	wait chan mat64.Dense
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The run function will launch a goroutine which will remain active thanks to a loop.
It allows the run function to finish an returns the channel as soon as possible to it can be used by the conductor.&lt;/p&gt;

&lt;h3 id=&#34;the-conductor&#34;&gt;The conductor&lt;/h3&gt;

&lt;p&gt;The conductor will be executed inside the main function in our example.&lt;/p&gt;

&lt;p&gt;The first step is to launch as many &lt;code&gt;run&lt;/code&gt; function as needed.&lt;/p&gt;

&lt;p&gt;There is no need to launch them in separate goroutines, because, as explained before,
the run function will returns the channel immediately because the intelligence is living in a goroutine already.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;for i := 0; i &amp;lt; n; i++ { // n is the dimension of the matrix
    cs[i] = run(i, time.Duration(rand.Intn(1e3))*time.Millisecond)
    ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then, as we have launched our workers, and as the communication channel exists, we should launch &lt;code&gt;n&lt;/code&gt; &amp;ldquo;angel&amp;rdquo; goroutines, that will take care of
sending back the matrix to all the workers.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;    ...
	node := &amp;lt;-cs[i]
	go func() {
		for {
			node.wait &amp;lt;- *m
		}
	}()
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we shall collect all the messages sent back by the goroutines to treat them and update the matrix as soon as a goroutine has finished.
I will use the &lt;code&gt;fanIn&lt;/code&gt; function as described by &lt;em&gt;Rob Pike&lt;/em&gt; in the IO Takl of 2012 (see references) and then go in a &lt;code&gt;for loop&lt;/code&gt; to get the results
as soon as they arrived:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-golang&#34;&gt;c := fanIn(cs...)
timeout := time.After(5 * time.Second)
for {
    select {
    case node := &amp;lt;-c:
        if node.run == true {
            fmt.Printf(&amp;quot;%v has finished\n&amp;quot;, node.id)
            // 0 its row in the matrix
            for c := 0; c &amp;lt; n; c++ {
                m.Set(node.id, c, 0)
            }
        }
    case &amp;lt;-timeout:
        fmt.Println(&amp;quot;Timeout&amp;quot;)
        return
    default:
        if mat64.Sum(m) == 0 {
            fmt.Println(&amp;quot;All done!&amp;quot;)
            return
        }
    }
}
fmt.Println(&amp;quot;This is the end!&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt; I have set up a timeout, just in case (&lt;a href=&#34;https://talks.golang.org/2012/concurrency.slide#36&#34;&gt;reference&lt;/a&gt;)&amp;hellip;
&lt;strong&gt;Note2&lt;/strong&gt; I do not talk about the fanIn funtion which is described &lt;a href=&#34;https://talks.golang.org/2012/concurrency.slide#28&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;the-test&#34;&gt;The test&lt;/h2&gt;

&lt;p&gt;Here is what I got when I launch the test:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;go run orchestrator.go 
I am 7, and I am running
I am 3, and I am running
I am 5, and I am running
3 has finished
5 has finished
I am 2, and I am running
I am 0, and I am running
0 has finished
I am 1, and I am running
I am 4, and I am running
4 has finished
7 has finished
2 has finished
1 has finished
All done!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pretty cool&lt;/p&gt;

&lt;p&gt;The complete source can be found &lt;a href=&#34;https://github.com/owulveryck/gorchestrator&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If you want to play: download go, setup a directory and a &lt;code&gt;$GOPATH&lt;/code&gt; then simply&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;go get github.com/owulveryck/gorchestrator
cd $GOPATH/src/github.com/owulveryck/gorchestrator
go run orchestrator.go
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;conclusions&#34;&gt;Conclusions&lt;/h1&gt;

&lt;p&gt;I&amp;rsquo;m really happy about this implementation. It is clear and concise, and no too far to be idiomatic go.&lt;/p&gt;

&lt;p&gt;What I would like to do now:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Read a TOSCA file (again) and pass the adjacency matrix to the orchestrator. That would do a complete orchestrator for cheap.&lt;/li&gt;
&lt;li&gt;Re-use an old implemenation of the &lt;a href=&#34;https://github.com/owulveryck/toscaviewer&#34;&gt;toscaviewer&lt;/a&gt;.
The idea is to implement a web server that serves the matrix as a json stream. This json will be used to update the SVG (via jquery),
and then we would be able to see the progession in a graphical way.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;STAY TUNED!!!&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&#34;references&#34;&gt;References&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://talks.golang.org/2012/concurrency.slide&#34;&gt;Go Concurrency Patterns (Rob Pike)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>TOSCA lifecycle as a digraph</title>
      <link>https://blog.owulveryck.info/2015/11/20/tosca-lifecycle-as-a-digraph/index.html</link>
      <pubDate>Fri, 20 Nov 2015 10:09:30 +0000</pubDate>
      
      <guid>https://blog.owulveryck.info/2015/11/20/tosca-lifecycle-as-a-digraph/index.html</guid>
      <description>

&lt;h1 id=&#34;about-tosca&#34;&gt;About TOSCA&lt;/h1&gt;

&lt;p&gt;The &lt;a href=&#34;https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=tosca&#34;&gt;TOSCA&lt;/a&gt; acronym stands for
&lt;em&gt;Topology and Orchestration Specification for Cloud Applications&lt;/em&gt;. It&amp;rsquo;s an &lt;a href=&#34;https://www.oasis-open.org&#34;&gt;OASIS&lt;/a&gt; standard.&lt;/p&gt;

&lt;p&gt;The purpose of the TOSCA project is to represent an application by its topology and formalize it using the TOSCA grammar.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;http://docs.oasis-open.org/tosca/TOSCA-Simple-Profile-YAML/v1.0/csprd01/TOSCA-Simp$le-Profile-YAML-v1.0-csprd01.html&#34;&gt;[TOSCA-Simple-Profile-YAML-v1.0]&lt;/a&gt;
current specification in YAML introduces the following concepts.&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;TOSCA YAML service template: A YAML document artifact containing a (TOSCA) service template that represents a Cloud application.&lt;/li&gt;
&lt;li&gt;TOSCA processor: An engine or tool that is capable of parsing and interpreting a TOSCA YAML service template for a particular purpose. For example, the purpose could be validation, translation or visual rendering.&lt;/li&gt;
&lt;li&gt;TOSCA orchestrator (also called orchestration engine): A TOSCA processor that interprets a TOSCA YAML service template then instantiates and deploys the described application in a Cloud.&lt;/li&gt;
&lt;li&gt;TOSCA generator: A tool that generates a TOSCA YAML service template. An example of generator is a modeling tool capable of generating or editing a TOSCA YAML service template (often such a tool would also be a TOSCA processor).&lt;/li&gt;
&lt;li&gt;TOSCA archive (or TOSCA Cloud Service Archive, or “CSAR”): a package artifact that contains a TOSCA YAML service template and other artifacts usable by a TOSCA orchestrator to deploy an application.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;my-work-with-tosca&#34;&gt;My work with TOSCA&lt;/h2&gt;

&lt;p&gt;I do believe that TOSCA may be a very good leverage to port a &amp;ldquo;legacy application&amp;rdquo; (aka &lt;em&gt;born in the datacenter&lt;/em&gt; application) into a cloud ready application without rewriting it completely to be cloud compliant.
To be clear, It may act on the hosting and execution plan of the application, and not on the application itself.&lt;/p&gt;

&lt;p&gt;A single wordpress installation in a TOSCA way as written &lt;a href=&#34;http://docs.oasis-open.org/tosca/TOSCA-Simple-Profile-YAML/v1.0/csprd01/TOSCA-Simple-Profile-YAML-v1.0-csprd01.html#_Toc430015847&#34;&gt;here&lt;/a&gt; is represented like that&lt;/p&gt;

&lt;p&gt;&lt;img class=&#34;img-square img-responsive&#34; src=&#34;http://docs.oasis-open.org/tosca/TOSCA-Simple-Profile-YAML/v1.0/csprd01/TOSCA-Simple-Profile-YAML-v1.0-csprd01_files/image035.png&#34; alt=&#34;Single Wordpress representation&#34;/&gt;&lt;/p&gt;

&lt;p&gt;While I was learnig GO, I have developped a &lt;a href=&#34;https://github.com/owulveryck/toscalib&#34;&gt;TOSCA lib&lt;/a&gt; and a &lt;a href=&#34;https://github.com/owulveryck/toscaviewer&#34;&gt;TOSCA processor&lt;/a&gt; which are, by far, not &lt;em&gt;idiomatic GO&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Here are two screenshots of the rendering in a web page made with my tool (and the graphviz product):&lt;/p&gt;

&lt;hr/&gt;

&lt;p&gt;&lt;em&gt;The graph representation of a &lt;em&gt;Single instance wordpress&lt;/em&gt;&lt;/em&gt;
&lt;img class=&#34;img-responsive&#34; src=&#34;https://blog.owulveryck.info/assets/images/toscaviewer_template_def.png&#34; alt=&#34;Tosca view ofthe single instance wordpress&#34;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;The graph representation of a lifecycle of &lt;em&gt;Single instance wordpress&lt;/em&gt;&lt;/em&gt;
&lt;img class=&#34;img-responsive&#34; src=&#34;https://blog.owulveryck.info/assets/images/toscaviewer_lifecycle_def.png&#34; alt=&#34;Lifecycle representation of the single wordpress instance representation&#34;/&gt;
&lt;hr/&gt;&lt;/p&gt;

&lt;p&gt;The TOSCA file is parsed with the help of the &lt;code&gt;TOSCALIB&lt;/code&gt; and then it fills an adjacency matrix (see &lt;a href=&#34;https://godoc.org/github.com/owulveryck/toscalib#ToscaDefinition.FillAdjacencyMatrix&#34;&gt;FillAdjacencyMatrix&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;http://graphviz.org&#34;&gt;graphviz&lt;/a&gt; take care of the (di)graph representation.&lt;/p&gt;

&lt;p&gt;What I would like to do now, is a little bit more: I would like to play with the graph and query it
Then I should perform requests on this graph. For example I could ask:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;What are the steps to go from the state Initial of the application, to the state running&lt;/em&gt; ?&lt;/li&gt;
&lt;li&gt;&lt;em&gt;What are the steps to go from stop to delete&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;and that would be &lt;strong&gt;the premise of a TOSCA orchestrator&lt;/strong&gt;.&lt;/p&gt;

&lt;h2 id=&#34;the-digraph-go-code&#34;&gt;The digraph go code&lt;/h2&gt;

&lt;p&gt;I&amp;rsquo;ve recently discoverd the &lt;a href=&#34;https://github.com/golang/tools/tree/master/cmd/digraph&#34;&gt;digraph&lt;/a&gt; tool, that I will use for querying the graphs.
The &lt;code&gt;digraph&lt;/code&gt; is represented as a map with a node as a key and its immediates successors as values:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// A graph maps nodes to the non-nil set of their immediate successors.
type graph map[string]nodeset

type nodeset map[string]bool
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;from-tosca-to-digraph&#34;&gt;From TOSCA to digraph&lt;/h2&gt;

&lt;p&gt;What I must do is to parse the adjacency matrix, get the &amp;ldquo;lifecycle action&amp;rdquo; related to the id and fill the graph g.&lt;/p&gt;

&lt;h1 id=&#34;let-s-go&#34;&gt;Let&amp;rsquo;s go&lt;/h1&gt;

&lt;p&gt;Considering the digraph code, what I need to do is simply to override the &lt;code&gt;parse&lt;/code&gt; method.&lt;/p&gt;

&lt;h2 id=&#34;principle&#34;&gt;Principle&lt;/h2&gt;

&lt;p&gt;I will fill the &lt;code&gt;graph&lt;/code&gt; with a string composed of &lt;em&gt;nodename:action&lt;/em&gt; as key.
For example, if I need to do a &amp;ldquo;Configure&amp;rdquo; action of node &amp;ldquo;A&amp;rdquo; after a &amp;ldquo;Start&amp;rdquo; action on node &amp;ldquo;B&amp;rdquo;, I will have the following entry in the map:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;g[&amp;quot;B:Start&amp;quot;] = &amp;quot;A:Configure&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So What I need to do is to parse the adjjacency matrix, do a matching with the row id and the &amp;ldquo;node:action&amp;rdquo; name, and fill the &lt;code&gt;graph g&lt;/code&gt; with the matching of the corresponding &amp;ldquo;node:action&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;I will fill a &lt;code&gt;map&lt;/code&gt; with the id of the node:action as key and the corresponding label as values:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-gloang&#34;&gt;for node, template := range toscaTemplate.TopologyTemplate.NodeTemplates {
        ids[template.GetConfigureIndex()] = fmt.Sprintf(&amp;quot;%v:Configure&amp;quot;, node)
        ids[template.GetCreateIndex()] = fmt.Sprintf(&amp;quot;%v:Create&amp;quot;, node)
        ids[template.GetDeleteIndex()] = fmt.Sprintf(&amp;quot;%v:Delete&amp;quot;, node)
        ids[template.GetInitialIndex()] = fmt.Sprintf(&amp;quot;%v:Initial&amp;quot;, node)
        ids[template.GetPostConfigureSourceIndex()] = fmt.Sprintf(&amp;quot;%v:PostConfigureSource&amp;quot;, node)
        ids[template.GetPostConfigureTargetIndex()] = fmt.Sprintf(&amp;quot;%v:PostconfigureTarget&amp;quot;, node)
        ids[template.GetPreConfigureSourceIndex()] = fmt.Sprintf(&amp;quot;%v:PreConfigureSource&amp;quot;, node)
        ids[template.GetPreConfigureTargetIndex()] = fmt.Sprintf(&amp;quot;%v:PreConfigureTarget&amp;quot;, node)
        ids[template.GetStartIndex()] = fmt.Sprintf(&amp;quot;%v:Start&amp;quot;, node)
        ids[template.GetStopIndex()] = fmt.Sprintf(&amp;quot;%v:Stop&amp;quot;, node)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then I can easily fill the &lt;code&gt;graph g&lt;/code&gt; from the adjacency matrix:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-gloang&#34;&gt;row, col := toscaTemplate.AdjacencyMatrix.Dims()
        for r := 1; r &amp;lt; row; r++ {
                for c := 1; c &amp;lt; col; c++ {
                        if adjacencyMatrix.At(r, c) == 1 {
                                g.addEdges(ids[r], ids[c])
                        }
                }
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;rsquo;s it&lt;/p&gt;

&lt;h1 id=&#34;the-final-function&#34;&gt;The final function&lt;/h1&gt;

&lt;p&gt;Here is the final parse function&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func parse(rd io.Reader) (graph, error) {
        g := make(graph)
        // Parse the input graph.
        var toscaTemplate toscalib.ToscaDefinition
        err := toscaTemplate.Parse(rd)
        if err != nil {
                return nil, err
        }
        // a map containing the ID and the corresponding action
        ids := make(map[int]string)
        // Fill in the graph with the toscaTemplate via the adjacency matrix
        for node, template := range toscaTemplate.TopologyTemplate.NodeTemplates {
                // Find the edges of the current node and add them to the graph

                ids[template.GetConfigureIndex()] = fmt.Sprintf(&amp;quot;%v:Configure&amp;quot;, node)
                ids[template.GetCreateIndex()] = fmt.Sprintf(&amp;quot;%v:Create&amp;quot;, node)
                ids[template.GetDeleteIndex()] = fmt.Sprintf(&amp;quot;%v:Delete&amp;quot;, node)
                ids[template.GetInitialIndex()] = fmt.Sprintf(&amp;quot;%v:Initial&amp;quot;, node)
                ids[template.GetPostConfigureSourceIndex()] = fmt.Sprintf(&amp;quot;%v:PostConfigureSource&amp;quot;, node)
                ids[template.GetPostConfigureTargetIndex()] = fmt.Sprintf(&amp;quot;%v:PostconfigureTarget&amp;quot;, node)
                ids[template.GetPreConfigureSourceIndex()] = fmt.Sprintf(&amp;quot;%v:PreConfigureSource&amp;quot;, node)
                ids[template.GetPreConfigureTargetIndex()] = fmt.Sprintf(&amp;quot;%v:PreConfigureTarget&amp;quot;, node)
                ids[template.GetStartIndex()] = fmt.Sprintf(&amp;quot;%v:Start&amp;quot;, node)
                ids[template.GetStopIndex()] = fmt.Sprintf(&amp;quot;%v:Stop&amp;quot;, node)
        }

        row, col := toscaTemplate.AdjacencyMatrix.Dims()
        for r := 1; r &amp;lt; row; r++ {
                for c := 1; c &amp;lt; col; c++ {
                        if adjacencyMatrix.At(r, c) == 1 {
                                g.addEdges(ids[r], ids[c])
                        }
                }
        }
        return g, nil
}

&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;grab-the-source-and-compile-it&#34;&gt;Grab the source and compile it&lt;/h1&gt;

&lt;p&gt;I have a github repo with the source.
It is go-gettable&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;go get github.com/owulveryck/digraph
cd $GOPATH/src/github.com/owulveryck/digraph &amp;amp;&amp;amp; go build
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;EDIT&lt;/strong&gt; As I continue to work on this tool, I have created a &amp;ldquo;blog&amp;rdquo; branch in the github which holds the version related to this post&lt;/p&gt;

&lt;h1 id=&#34;example&#34;&gt;Example&lt;/h1&gt;

&lt;p&gt;I will use the the same example as described below: the single instance wordpress.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve extracted the YAML and placed in in the file &lt;a href=&#34;https://github.com/owulveryck/toscaviewer/blob/master/examples/tosca_single_instance_wordpress.yaml&#34;&gt;tosca_single_instance_wordpress.yaml&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s query the nodes first:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;curl -s https://raw.githubusercontent.com/owulveryck/toscaviewer/master/examples/tosca_single_instance_wordpress.yaml | ./digraph nodes
mysql_database:Configure
mysql_database:Create
mysql_database:Start
mysql_dbms:Configure
mysql_dbms:Create
mysql_dbms:Start
server:Configure
server:Create
server:Start
webserver:Configure
webserver:Create
webserver:Start
wordpress:Configure
wordpress:Create
wordpress:Start

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;so far, so good&amp;hellip;&lt;/p&gt;

&lt;p&gt;Now, I can I go from a &lt;code&gt;Server:Create&lt;/code&gt; to a running instance &lt;code&gt;wordpress:Start&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -s https://raw.githubusercontent.com/owulveryck/toscaviewer/master/examples/tosca_single_instance_wordpress.yaml | ./digraph somepath server:Create wordpress:Start
server:Create
server:Configure
server:Start
mysql_dbms:Create
mysql_dbms:Configure
mysql_dbms:Start
mysql_database:Create
mysql_database:Configure
mysql_database:Start
wordpress:Create
wordpress:Configure
wordpress:Start
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cool!&lt;/p&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;The tool sounds ok. What I may add:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;a command to display the full lifecycle (finding the entry and the exit points in the matrix and call somepath with it)&lt;/li&gt;
&lt;li&gt;get the tosca &lt;code&gt;artifacts&lt;/code&gt; and display them instead of the label to generate a deployment plan&lt;/li&gt;
&lt;li&gt;execute the command in &lt;code&gt;goroutines&lt;/code&gt; to make them concurrent&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And of course validate any other TOSCA definition to go through a bug hunting party&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>